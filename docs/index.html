<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Zixing Guan, Ruoyun Yu, Siyi Li">
<meta name="dcterms.date" content="2025-04-25">

<title>CASA0025 Interactive Application</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-3f3f9919b3835604a26bc531ace6acdb.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-3f3f9919b3835604a26bc531ace6acdb.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7026a1002ff3d6519a94cc5e6fbb9ee0.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-e05ccfec0bb336031d76a8ac60be18fc.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent quarto-dark"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = true;
    const darkModeDefault = authorPrefersDark;
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CASA0025 Interactive Application</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Zixing Guan, Ruoyun Yu, Siyi Li </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2025-04-25</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="section" class="level1">
<h1></h1>
</section>
<section id="urban-carbon-archives-of-chinas-five-major-urban-agglomerations" class="level1 page-columns page-full">
<h1>Urban Carbon Archives of China’s Five Major Urban Agglomerations</h1>
<section id="project-summary" class="level2">
<h2 class="anchored" data-anchor-id="project-summary">Project Summary</h2>
<p>The aim of this project is to develop an application to compare the gap between building carbon emissions and vegetation carbon absorption in China’s five major urban agglomerations. This application can not only provide data support and decision-making references for China to achieve its 2060 “carbon neutrality” goal, but also assist researchers around the world in addressing global warming.</p>
<section id="problem-statement" class="level3">
<h3 class="anchored" data-anchor-id="problem-statement">Problem Statement</h3>
<p>The negative impact of global warming on the world continues to intensify <span class="citation" data-cites="Ahmad2022">(<a href="#ref-Ahmad2022" role="doc-biblioref">Ahmad et al. 2022</a>)</span>. Since 2005, China has become the world’s largest carbon emitter <span class="citation" data-cites="Zuo2022">(<a href="#ref-Zuo2022" role="doc-biblioref">Zuo et al. 2022</a>)</span>. In response to this situation, China has proposed the goal of achieving “carbon neutrality” by 2060 <span class="citation" data-cites="Yang2022">(<a href="#ref-Yang2022" role="doc-biblioref">J. Yang et al. 2022</a>)</span>, which can be achieved through various strategies, including social and natural contributions. Among them, natural contributions mainly involve the carbon sequestration capacity of plant ecosystems <span class="citation" data-cites="AlKafy2023">(<a href="#ref-AlKafy2023" role="doc-biblioref">Al Kafy et al. 2023</a>)</span>. However, natural contributions alone cannot completely offset the <span class="math inline">\(CO_{2}\)</span> produced, and social support is needed to bridge the gap between carbon emissions and carbon absorption <span class="citation" data-cites="Wu2022">(<a href="#ref-Wu2022" role="doc-biblioref">Wu, Tian, and Guo 2022</a>)</span>. In addition, as high-risk areas for ecological and environmental issues <span class="citation" data-cites="Liu2018">(<a href="#ref-Liu2018" role="doc-biblioref">Liu et al. 2018</a>)</span>, urban agglomerations are important responsible entities for achieving the above goals. As a result, the developed application aims to provide a visualization tool for quantifying the gap in “carbon neutrality” process, thereby providing a reference for the social contribution required to achieve “carbon neutrality”.</p>
</section>
<section id="end-user" class="level3">
<h3 class="anchored" data-anchor-id="end-user">End User</h3>
<p>This application is aimed at diverse user groups worldwide, including policy makers (e.g.&nbsp;environmental management officials), environmental researchers, corporate sustainability leaders, environmental non-governmental organizations, as well as investors and financial institutions (e.g.&nbsp;carbon finance product developers). These user groups collectively face an urgent need for accurate assessment of carbon emissions and absorption in urban agglomerations, requiring precise and visualized data to support their policy-making, academic research, corporate strategy, public education, and investment decisions. By providing detailed carbon balance analysis of urban agglomerations in China, this application can become a scientific and intuitive decision-making tool for professionals in different fields.</p>
</section>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>Considering the high correlation between energy consumption and carbon emissions, nighttime light (NTL) data can be used to estimate the spatial distribution of carbon emissions <span class="citation" data-cites="Wang2024">(<a href="#ref-Wang2024" role="doc-biblioref">Wang et al. 2024</a>)</span>. This project obtained the latest generation of nighttime light data NPP-VIIRS through GEE.</p>
<p>The carbon sequestration capacity of plant ecosystems has been proven to be an important force in reducing atmospheric carbon dioxide accumulation and mitigating climate change <span class="citation" data-cites="Legesse2024">(<a href="#ref-Legesse2024" role="doc-biblioref">Legesse, Degefa, and Soromessa 2024</a>)</span>, so the net primary productivity (NPP) index of vegetation can serve as a proxy indicator for carbon absorption capacity <span class="citation" data-cites="Das2023">(<a href="#ref-Das2023" role="doc-biblioref">Das et al. 2023</a>)</span>. The dataset for estimating carbon absorption obtained through GEE is shown in the table below. Considering the availability of NPP-VIIRS data, the comprehensive time span of the above types of data is from January 1, 2015 to December 31, 2023. Furthermore, the geographical boundary data of urban agglomerations is GADM data (version 4.1) <span class="citation" data-cites="gadm2022">(<a href="#ref-gadm2022" role="doc-biblioref"><span>“GADM: Global Administrative Areas”</span> 2022</a>)</span>, and the population data is also obtained through the GEE platform.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 53%">
<col style="width: 31%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th>Indicator</th>
<th>Dataset</th>
<th>Time Span</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Net primary productivity index (NDVI)</td>
<td>MODIS/061/MOD13A2</td>
<td>2015-2023</td>
</tr>
<tr class="even">
<td>Evaporation and transpiration capacity</td>
<td>MODIS/061/MOD16A2GF</td>
<td>2015-2020</td>
</tr>
<tr class="odd">
<td>Evaporation and transpiration capacity</td>
<td>MODIS/061/MOD16A2</td>
<td>2021-2023</td>
</tr>
<tr class="even">
<td>Precipitation, temperature, and short radiation data</td>
<td>NASA/FLDAS/NOAH01/C/GL/M/V001</td>
<td>2015-2023</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="methodology" class="level2">
<h2 class="anchored" data-anchor-id="methodology">Methodology</h2>
<section id="data-preprocessing" class="level4">
<h4 class="anchored" data-anchor-id="data-preprocessing">Data preprocessing</h4>
<p>In general, the raw data has been standardized and preprocessed through spatial cropping, missing value filling and smoothing, mask unification, and outlier processing, providing a high-quality data foundation for subsequent estimation of carbon emissions and carbon sequestration at the city scale and analysis of temporal changes.</p>
<p>After data preprocessing, the main step is to estimate the specific carbon emissions and carbon absorption, and calculate the difference between the two, which is represented by the total amount of carbon dioxide.</p>
</section>
<section id="carbon-emissions" class="level4">
<h4 class="anchored" data-anchor-id="carbon-emissions">Carbon emissions</h4>
<p>The estimation method of carbon emissions is improved based on the existing model <span class="citation" data-cites="yang2022">(<a href="#ref-yang2022" role="doc-biblioref">T. Yang et al. 2022</a>)</span> by considering the impact of urban area. Firstly, monthly average NTL data (<span class="math inline">\(nW/pixel\)</span>) of cities within five major urban agglomerations were obtained using the NPP-VIIRS dataset. Then, based on converting the NTL data into <span class="math inline">\(nW\)</span> per m², calculate the total NTL intensity (<span class="math inline">\(nW\)</span>) for each city using the following formula.</p>
<p><span class="math display">\[
NTL_{\text{m²}} = \frac{NTL_{\text{pixel}}}{10^4} \times \pi
\]</span></p>
<p><span class="math display">\[
  NTL_{total} = NTL_{m^2} \times A_{city}  
\]</span></p>
<p>where,</p>
<p><span class="math inline">\(NTL_{total}\)</span>: the total NTL intensity of the city (nW);</p>
<p><span class="math inline">\(NTL_{pixel}\)</span>: the monthly average nighttime light data for each pixel (nW/cm²/sr);</p>
<p><span class="math inline">\(NTL_{m^2}\)</span>: : the monthly average nighttime light data for each m^2 (nW/m²);</p>
<p><span class="math inline">\(A_{city}\)</span>: the area of the city (m²).</p>
<p>Next, based on the region where the city is located (eastern/central/western), different linear transformation formulas (as shown in the table below) will be used to calculate the total carbon emissions of the city.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 44%">
<col style="width: 46%">
</colgroup>
<tbody>
<tr class="odd">
<td><strong>Region</strong></td>
<td><strong>Province</strong></td>
<td><strong>Formula</strong></td>
</tr>
<tr class="even">
<td>Western</td>
<td>Sichuan, Chongqing</td>
<td><span class="math display">\[   NC = \log(NTL_{total}) \times 0.3645 + (V_{it} + 2.2189)   \]</span></td>
</tr>
<tr class="odd">
<td>Central</td>
<td>Anhui; Hubei, Hunan, Jiangxi</td>
<td><span class="math display">\[   NC = \log(NTL_{total}) \times 1.0484 + (V_{it} - 6.1871)   \]</span></td>
</tr>
<tr class="even">
<td>Eastern</td>
<td>Beijing, Tianjin, Hebei; Shanghai, Jiangsu, Zhejiang; Guangdong</td>
<td><span class="math display">\[   NC = \log(NTL_{total}) \times 0.8773 + (V_{it} - 4.2414)   \]</span></td>
</tr>
</tbody>
</table>
<p>where,</p>
<p><span class="math inline">\(NC\)</span>: <span class="math inline">\(CO_{2}\)</span> emission amount (10k tons);</p>
<p><span class="math inline">\(NTL_{total}\)</span>: the total NTL intensity of the city (nW);</p>
<p><span class="math inline">\(V_{it}\)</span>: fixed impact value (see the table below).</p>
<table class="caption-top table">
<colgroup>
<col style="width: 23%">
<col style="width: 43%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th>Region</th>
<th>Province</th>
<th>Vit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Western</td>
<td>Sichuan</td>
<td>0.4006</td>
</tr>
<tr class="even">
<td></td>
<td>Chongqing</td>
<td>-0.0131</td>
</tr>
<tr class="odd">
<td>Central</td>
<td>Anhui; Hubei, Hunan, Jiangxi</td>
<td>/</td>
</tr>
<tr class="even">
<td>Eastern</td>
<td>Beijing</td>
<td>1.2970</td>
</tr>
<tr class="odd">
<td></td>
<td>Tianjin</td>
<td>0.7509</td>
</tr>
<tr class="even">
<td></td>
<td>Hebei</td>
<td>-0.2134</td>
</tr>
<tr class="odd">
<td></td>
<td>Shanghai</td>
<td>1.0254</td>
</tr>
<tr class="even">
<td></td>
<td>Jiangsu</td>
<td>-0.6130</td>
</tr>
<tr class="odd">
<td></td>
<td>Zhejiang</td>
<td>-0.4030</td>
</tr>
<tr class="even">
<td></td>
<td>Guangdong</td>
<td>-0.3258</td>
</tr>
</tbody>
</table>
</section>
<section id="carbon-sequestration" class="level4">
<h4 class="anchored" data-anchor-id="carbon-sequestration">Carbon sequestration</h4>
<p>As for carbon sequestration, this project refers to The Carnegie-Ames-Stanford approach (CASA) Biosphere model <span class="citation" data-cites="Potter1993">(<a href="#ref-Potter1993" role="doc-biblioref">Potter et al. 1993</a>)</span>. The calculation method is based on the carbon absorption related datasets obtained from the GEE platform to estimate carbon absorption. The calculation formula for NPP is as follows.</p>
<p><span class="math display">\[NPP=PAR\times FPAR\times\epsilon\]</span></p>
<p>where,</p>
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 37%">
<col style="width: 35%">
</colgroup>
<thead>
<tr class="header">
<th>Parameter</th>
<th>Formula</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>PAR (Photosynthetically Active Radiation)</td>
<td><span class="math display">\[   PAR = Swnet\_tavg \times 0.5 \times \left(\frac{30\,\text{days}}{106}\right)  \]</span></td>
<td><p>where,</p>
<p><span class="math inline">\(Swnet\_tavg\)</span>: The average value of shortwave net radiation (MJ<span class="math inline">\(/m^2/month\)</span>)</p>
<p><span class="math inline">\(0.5\)</span>: Proportion of photosynthetically active radiation in shortwave radiation;</p>
<p>Convert the results to a monthly scale.</p></td>
</tr>
<tr class="even">
<td>FPAR (Photosynthetically Active Radiation Absorption Ratio)</td>
<td><p><span class="math display">\[  FPAR = \frac{SR - SR_{min}}{SR_{max} - SR_{min}}  \]</span></p>
<p><span class="math display">\[     SR = \frac{NDVI + 1}{1 - NDVI}     \]</span></p></td>
<td><p>where,</p>
<p><span class="math inline">\(SR\)</span>: Reflectance;</p>
<p><span class="math inline">\(NDVI\)</span>: the Normalized Difference Vegetation Index;</p>
<p><span class="math inline">\(SR_{max}\)</span> and <span class="math inline">\(SR_{min}\)</span>: The minimum and maximum values of <span class="math inline">\(SR\)</span>.</p>
<p>The value of <span class="math inline">\(FPAR\)</span> is restricted between 0 and 0.95.</p></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\epsilon\)</span> (Energy Conversion Efficiency)</td>
<td><p><span class="math display">\[\epsilon = Te1 \times Te2 \times WE \times 0.95 \]</span></p>
<p><span class="math display">\[   Te1 = 0.8 + 0.027T - 0.00005T^2   \]</span></p>
<p><span class="math display">\[ Te2 = \frac{1.184}{1 + e^{-0.2(T-10)} + e^{0.3(T+10)}} \]</span></p></td>
<td><p>where,</p>
<p><span class="math inline">\(T\)</span>: Temperature (typically in °C);</p>
<p><span class="math inline">\(WE\)</span>: Water Use Efficiency.</p></td>
</tr>
</tbody>
</table>
<p>Because the NPP calculated by the above formula is in units of carbon, it needs to be converted into an amount in units of carbon dioxide using the following formula.</p>
<p><span class="math display">\[S_{CO_2}=NPP\times\frac{44}{12}\]</span></p>
<p>where,</p>
<p><span class="math inline">\(S_{CO_2}\)</span>: Carbon dioxide sequestration capacity of plants (g <span class="math inline">\(CO_{2}\)</span>/m²);</p>
<p><span class="math inline">\(NPP\)</span>: Net primary productivity of plants (g <span class="math inline">\(C\)</span>/m²);</p>
<p><span class="math inline">\(\frac{44}{12}\)</span>: This is a conversion factor derived from the molecular weight ratio of carbon dioxide (CO₂) to carbon (C).</p>
<p>Finally, the total carbon sequestration amount needs to be obtained by considering the urban area (see formula below).</p>
<p><span class="math display">\[
TCS=S_{CO_2}\times A_{city}
\]</span></p>
<p>where,</p>
<p><span class="math inline">\(TCS\)</span>: total carbon dioxide sequestration amount (10k tons);</p>
<p><span class="math inline">\(S_{CO_2}\)</span>: Carbon dioxide sequestration capacity of plants (g <span class="math inline">\(CO_{2}\)</span>/m²);</p>
<p><span class="math inline">\(A_{city}\)</span>: the area of the city (m²).</p>
<p>After calculating the total amount of carbon dioxide emissions and carbon sequestration , the net carbon dioxide emissions can be obtained through the following formula.</p>
<p><span class="math display">\[
NC_{CO_2}=NC-TCS
\]</span></p>
<p>where,</p>
<p><span class="math inline">\(NC_{CO_2}\)</span>: Net <span class="math inline">\(CO_{2}\)</span> emissions (10k tons);</p>
<p><span class="math inline">\(NC\)</span>: <span class="math inline">\(CO_{2}\)</span> emissions (10k tons);</p>
<p><span class="math inline">\(TCS\)</span>: total <span class="math inline">\(CO_{2}\)</span> sequestration amount (10k tons).</p>
</section>
</section>
<section id="interface" class="level2">
<h2 class="anchored" data-anchor-id="interface">Interface</h2>
<p>Here are several key components of the application interface:</p>
<ol type="1">
<li><p><strong>Custom spatio-temporal range</strong>：On the left side of the main interface of the application, an interactive dashboard is displayed, where users can select different years, months, urban agglomerations, provinces, and cities according to their needs. After clicking the corresponding load button, the interactive map in the middle will display the layer of the selected area. Through this customized dashboard, users can quickly select research areas of interest.</p></li>
<li><p><strong>Interactive map</strong>: The middle part of the application interface will provide an interactive map, where users can zoom in and out to view specific areas. Additionally, at the top of the interface, users can view the map in a targeted manner by selecting different layers (as shown in the table below) based on their research interests. In addition, users can click on any city area to view the layers.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 19%">
<col style="width: 80%">
</colgroup>
<thead>
<tr class="header">
<th>Layer</th>
<th>Indicator</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>CO₂ NetEmissions</td>
</tr>
<tr class="even">
<td>2</td>
<td>CO₂ Emissions</td>
</tr>
<tr class="odd">
<td>3</td>
<td>CO₂ Sequestration</td>
</tr>
<tr class="even">
<td>4</td>
<td>Nighttime Light</td>
</tr>
<tr class="odd">
<td>5</td>
<td>FPAR (Photosynthetically Active Radiation Absorption Ratio)</td>
</tr>
<tr class="even">
<td>6</td>
<td>Epsilon (Energy Conversion Effciency)</td>
</tr>
<tr class="odd">
<td>7</td>
<td>NPP (Net Carbon Sequestration)</td>
</tr>
<tr class="even">
<td>8</td>
<td>WE (Water Use Effciency)</td>
</tr>
</tbody>
</table></li>
<li><p><strong>Visual charts</strong>: After the user selects urban agglomeration, province, city, and specific indicator on the left panel and clicks the corresponding button to load them, the dashboard on the right side of the application interface will display visual charts. They are line chart comparing monthly changes in CO₂ emissions, sequestration, and net emissions; Line chart of monthly changes in multiple indicators, as well as a pie chart of the proportion of annual net CO₂ emissions of each city in its urban agglomeration. These charts can help users understand data in a visual way.</p></li>
</ol>
</section>
<section id="the-application" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-application">The Application</h2>
<div class="column-page">
<iframe src="https://ruoyun2025.projects.earthengine.app/view/urban-carbon-archives-of-chinas-five-major-urban-agglomeration" width="120%" height="800px">
</iframe>
</div>
</section>
<section id="how-it-works" class="level2">
<h2 class="anchored" data-anchor-id="how-it-works">How it Works</h2>
<section id="data-import-and-preliminary-processing" class="level3">
<h3 class="anchored" data-anchor-id="data-import-and-preliminary-processing"><strong>1.</strong> Data Import and Preliminary Processing</h3>
<p>This section loads the city list (UG_list) and Chinese city boundary data (gadm41_CHN_2hp). By matching provinces and city names, the city boundaries of the five major urban agglomerations in China are extracted, and attributes such as <em>region</em> and <span class="math inline">\(V_{it}\)</span> value are attached. In addition, the researchers loaded VIIRS nighttime light data as the basis for subsequent CO₂ emissions estimates. However, only preliminary data import is carried out at this stage, and more remote sensing data such as meteorology and vegetation data will be imported in subsequent analysis steps to further calculate carbon sequestration and its key indicators.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ====================== Loading and processing data ======================</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selectedCitiesTable <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">'projects/ee-siyili/assets/UG_list'</span>)<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> allChinaCities <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">"projects/ee-siyili/assets/gadm41_CHN_2_shp"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">"COUNTRY"</span><span class="op">,</span> <span class="st">"China"</span>))<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Match the urban list with the national boundaries</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> matchedCities <span class="op">=</span> selectedCitiesTable<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(row) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> city <span class="op">=</span> row<span class="op">.</span><span class="fu">getString</span>(<span class="st">"city"</span>)<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> province <span class="op">=</span> row<span class="op">.</span><span class="fu">getString</span>(<span class="st">"province"</span>)<span class="op">;</span> </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> matches <span class="op">=</span> allChinaCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">"NAME_1"</span><span class="op">,</span> province)<span class="op">,</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">"NAME_2"</span><span class="op">,</span> city)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  ))<span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mergedGeom <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(matches)<span class="op">.</span><span class="fu">union</span>()<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> count <span class="op">=</span> matches<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract other attribute information</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> region <span class="op">=</span> row<span class="op">.</span><span class="fu">getString</span>(<span class="st">"region"</span>)<span class="op">;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> Vit <span class="op">=</span> row<span class="op">.</span><span class="fu">getNumber</span>(<span class="st">"Vit"</span>)<span class="op">;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> urbanAgg <span class="op">=</span> row<span class="op">.</span><span class="fu">getString</span>(<span class="st">"UrbanAgg"</span>)<span class="op">;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(mergedGeom)<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">'NAME_2'</span><span class="op">:</span> city<span class="op">,</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">'NAME_1'</span><span class="op">:</span> province<span class="op">,</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">'region'</span><span class="op">:</span> region<span class="op">,</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Vit'</span><span class="op">:</span> Vit<span class="op">,</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">'UrbanAgg'</span><span class="op">:</span> urbanAgg<span class="op">,</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">'match_count'</span><span class="op">:</span> count</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gt</span>(<span class="st">'match_count'</span><span class="op">,</span> <span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co">// Load base image dataset</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'NOAA/VIIRS/DNB/MONTHLY_V1/VCMSLCFG'</span>)  </span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">filterDate</span>(<span class="st">'2014-01-01'</span><span class="op">,</span> <span class="st">'2023-12-31'</span>)<span class="op">;</span>  <span class="co">// VIIRS monthly nighttime light Dataset</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="interface-and-interactive-controls-design" class="level3">
<h3 class="anchored" data-anchor-id="interface-and-interactive-controls-design"><strong>2.</strong> Interface and Interactive Controls Design</h3>
<p>This section aims to built an interactive interface, including the main map (MyMap), status prompt bar, chart panel, and various selectors, supporting flexible filtering of year, month, urban agglomeration, province, city, and indicators. Simultaneously, it also provides a clear button and 3 load data buttons to dynamically update maps and charts. The interface facilitates users to quickly locate or switch cities, provinces, and urban agglomerations.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ====================== Map and interface initialisation ======================</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> MyMap <span class="op">=</span> ui<span class="op">.</span><span class="fu">Map</span>()<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> statusLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Waiting for the operation...'</span>)<span class="op">;</span> <span class="co">// Real-time display of operation progress</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> indicatorChartWidget <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">updateStatus</span>(msg) {</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  statusLabel<span class="op">.</span><span class="fu">setValue</span>(msg)<span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>MyMap<span class="op">.</span><span class="fu">addLayer</span>(matchedCities<span class="op">.</span><span class="fu">style</span>({<span class="dt">color</span><span class="op">:</span> <span class="st">'gray'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'00000000'</span>})<span class="op">,</span> {}<span class="op">,</span> <span class="st">'urban boundary'</span>)<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>MyMap<span class="op">.</span><span class="fu">setCenter</span>(<span class="dv">104</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">// =============== Legend panel ================</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> allLegendPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'horizontal'</span>)<span class="op">,</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">position</span><span class="op">:</span> <span class="st">'bottom-left'</span><span class="op">,</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">padding</span><span class="op">:</span> <span class="st">'8px'</span><span class="op">,</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">backgroundColor</span><span class="op">:</span> <span class="st">'rgba(255,255,255,0.8)'</span><span class="op">,</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="st">'500px'</span><span class="op">,</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxHeight</span><span class="op">:</span> <span class="st">'115px'</span><span class="op">,</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">whiteSpace</span><span class="op">:</span> <span class="st">'nowrap'</span><span class="op">,</span> </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>MyMap<span class="op">.</span><span class="fu">add</span>(allLegendPanel)<span class="op">;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Generate legends for each layer</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createLegendBox</span>(title<span class="op">,</span> palette<span class="op">,</span> min<span class="op">,</span> max) {</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> titleLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">value</span><span class="op">:</span> title<span class="op">,</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontWeight</span><span class="op">:</span> <span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="st">'12px'</span><span class="op">,</span> <span class="dt">margin</span><span class="op">:</span> <span class="st">'2px 4px'</span>}</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> colorBar <span class="op">=</span> ui<span class="op">.</span><span class="fu">Thumbnail</span>({</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">image</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelLonLat</span>()<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">multiply</span>((max <span class="op">-</span> min) <span class="op">/</span> <span class="fl">100.0</span>)<span class="op">.</span><span class="fu">add</span>(min)<span class="op">,</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">params</span><span class="op">:</span> {</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">bbox</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">dimensions</span><span class="op">:</span> <span class="st">'100x10'</span><span class="op">,</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">format</span><span class="op">:</span> <span class="st">'png'</span><span class="op">,</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">min</span><span class="op">:</span> min<span class="op">,</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>      <span class="dt">max</span><span class="op">:</span> max<span class="op">,</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>      <span class="dt">palette</span><span class="op">:</span> palette</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">stretch</span><span class="op">:</span> <span class="st">'horizontal'</span><span class="op">,</span> <span class="dt">margin</span><span class="op">:</span> <span class="st">'4px 0'</span>}</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> numTicks <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> step <span class="op">=</span> (max <span class="op">-</span> min) <span class="op">/</span> (numTicks <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> tickLabels <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> numTicks<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> value <span class="op">=</span> (min <span class="op">+</span> i <span class="op">*</span> step)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    tickLabels<span class="op">.</span><span class="fu">push</span>(ui<span class="op">.</span><span class="fu">Label</span>(value<span class="op">,</span> {</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>      <span class="dt">margin</span><span class="op">:</span> <span class="st">'0 2px'</span><span class="op">,</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>      <span class="dt">textAlign</span><span class="op">:</span> <span class="st">'center'</span><span class="op">,</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stretch</span><span class="op">:</span> <span class="st">'horizontal'</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> labelRow <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    <span class="dt">widgets</span><span class="op">:</span> tickLabels<span class="op">,</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'horizontal'</span>)<span class="op">,</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">stretch</span><span class="op">:</span> <span class="st">'horizontal'</span>}</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> box <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    <span class="dt">widgets</span><span class="op">:</span> [titleLabel<span class="op">,</span> colorBar<span class="op">,</span> labelRow]<span class="op">,</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>      <span class="dt">margin</span><span class="op">:</span> <span class="st">'0 10px'</span><span class="op">,</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="st">'120px'</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> box<span class="op">;</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a><span class="co">// =============== UI control design ================</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> currentCityName <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a><span class="co">// Creating a year selector</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearSelect <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>  <span class="dt">items</span><span class="op">:</span> [<span class="st">'2014'</span><span class="op">,</span> <span class="st">'2015'</span><span class="op">,</span> <span class="st">'2016'</span><span class="op">,</span> <span class="st">'2017'</span><span class="op">,</span><span class="st">'2018'</span><span class="op">,</span> <span class="st">'2019'</span><span class="op">,</span> <span class="st">'2020'</span><span class="op">,</span><span class="st">'2021'</span><span class="op">,</span> <span class="st">'2022'</span><span class="op">,</span> <span class="st">'2023'</span>]<span class="op">,</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">'2023'</span><span class="op">,</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>  <span class="dt">placeholder</span><span class="op">:</span> <span class="st">'Select Year'</span></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a><span class="co">// Creating a month selector</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthSlider <span class="op">=</span> ui<span class="op">.</span><span class="fu">Slider</span>({</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="co">// 0 for the whole year</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>  <span class="dt">step</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">stretch</span><span class="op">:</span> <span class="st">'horizontal'</span>}<span class="op">,</span></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>  <span class="dt">onChange</span><span class="op">:</span> <span class="kw">function</span>(month) {</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (currentCityName <span class="op">!==</span> <span class="kw">null</span>) {</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>    chartPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> cityFeature <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_2'</span><span class="op">,</span> currentCityName))<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>    cityFeature<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(f) {</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (f) {</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> cityGeom <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(f)<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> selectedYear <span class="op">=</span> yearSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateMap</span>(selectedYear<span class="op">,</span> cityGeom<span class="op">,</span> month)<span class="op">;</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plotSinglecityCarbonChart</span>(currentCityName<span class="op">,</span> cityGeom<span class="op">,</span> <span class="pp">parseInt</span>(selectedYear)<span class="op">,</span> month)</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">then</span>(<span class="kw">function</span>() {</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>          <span class="fu">plotCityIndicatorChart</span>(currentCityName<span class="op">,</span> cityGeom<span class="op">,</span> <span class="pp">parseInt</span>(selectedYear)<span class="op">,</span> indicatorSelect<span class="op">.</span><span class="fu">getValue</span>())<span class="op">;</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateStatus</span>(<span class="st">'Select Month：'</span> <span class="op">+</span> month)<span class="op">;</span></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateStatus</span>(<span class="st">'No city information found'</span>)<span class="op">;</span></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Please select month (0 = all year)'</span>)<span class="op">;</span></span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthTipLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">'Slide to update month selection'</span><span class="op">,</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">'gray'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="st">'11px'</span><span class="op">,</span> <span class="dt">margin</span><span class="op">:</span> <span class="st">'4px 0 8px 8px'</span>}</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a><span class="co">// Creating a clear button</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clearButton <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">'Clear Selection'</span><span class="op">,</span></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>  <span class="dt">onClick</span><span class="op">:</span> <span class="kw">function</span>() {</span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>    currentCityName <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> layers <span class="op">=</span> MyMap<span class="op">.</span><span class="fu">layers</span>()<span class="op">;</span></span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (layers<span class="op">.</span><span class="fu">length</span>() <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>    layers<span class="op">.</span><span class="fu">remove</span>(layers<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>    MyMap<span class="op">.</span><span class="fu">addLayer</span>(matchedCities<span class="op">.</span><span class="fu">style</span>({<span class="dt">color</span><span class="op">:</span> <span class="st">'gray'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'00000000'</span>})<span class="op">,</span> {}<span class="op">,</span> <span class="st">'urban boundary'</span>)<span class="op">;</span></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>    allLegendPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>    chartPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>    urbanAggSelect<span class="op">.</span><span class="fu">setValue</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>    provinceSelect<span class="op">.</span><span class="fu">items</span>()<span class="op">.</span><span class="fu">reset</span>([])<span class="op">;</span></span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>    provinceSelect<span class="op">.</span><span class="fu">setValue</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>    citySelect<span class="op">.</span><span class="fu">items</span>()<span class="op">.</span><span class="fu">reset</span>([])<span class="op">;</span></span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>    citySelect<span class="op">.</span><span class="fu">setValue</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateStatus</span>(<span class="st">'City selection has been cleared. Please select again.'</span>)<span class="op">;</span></span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a><span class="co">// Creating a city selector</span></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> urbanAggSelect <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({<span class="dt">placeholder</span><span class="op">:</span> <span class="st">'Select Urban Agglomeration'</span>})<span class="op">;</span></span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> provinceSelect <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({<span class="dt">placeholder</span><span class="op">:</span> <span class="st">'Select Province'</span>})<span class="op">;</span></span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> citySelect <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({<span class="dt">placeholder</span><span class="op">:</span> <span class="st">'Select City'</span>})<span class="op">;</span></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> urbanAggList <span class="op">=</span> [</span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Beijing-Tianjin-Hebei'</span><span class="op">,</span></span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Yangtze River Delta'</span><span class="op">,</span></span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Pearl River Delta'</span><span class="op">,</span></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Middle Yangtze River'</span><span class="op">,</span></span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Chengdu-Chongqing'</span></span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>]<span class="op">;</span></span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>urbanAggSelect<span class="op">.</span><span class="fu">items</span>()<span class="op">.</span><span class="fu">reset</span>(urbanAggList)<span class="op">;</span></span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a><span class="co">// Urban Agglomeration</span></span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>urbanAggSelect<span class="op">.</span><span class="fu">onChange</span>(<span class="kw">function</span>(urbanAgg) {</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> provinces <span class="op">=</span> matchedCities</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'UrbanAgg'</span><span class="op">,</span> urbanAgg))</span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">'NAME_1'</span>)</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">distinct</span>()</span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">sort</span>()<span class="op">;</span></span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>  provinces<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(provinceList) {</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>    provinceSelect<span class="op">.</span><span class="fu">items</span>()<span class="op">.</span><span class="fu">reset</span>(provinceList)<span class="op">;</span></span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>    provinceSelect<span class="op">.</span><span class="fu">setValue</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>    citySelect<span class="op">.</span><span class="fu">items</span>()<span class="op">.</span><span class="fu">reset</span>([])<span class="op">;</span></span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>    citySelect<span class="op">.</span><span class="fu">setValue</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (urbanAgg) {</span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> urbanAggCities <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'UrbanAgg'</span><span class="op">,</span> urbanAgg))<span class="op">;</span></span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> urbanAggGeometry <span class="op">=</span> urbanAggCities<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> layers <span class="op">=</span> MyMap<span class="op">.</span><span class="fu">layers</span>()<span class="op">;</span></span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (layers<span class="op">.</span><span class="fu">length</span>() <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a>      layers<span class="op">.</span><span class="fu">remove</span>(layers<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>    MyMap<span class="op">.</span><span class="fu">addLayer</span>(matchedCities<span class="op">.</span><span class="fu">style</span>({<span class="dt">color</span><span class="op">:</span> <span class="st">'gray'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'00000000'</span>})<span class="op">,</span> {}<span class="op">,</span> <span class="st">'urban boundary'</span>)<span class="op">;</span></span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>    MyMap<span class="op">.</span><span class="fu">addLayer</span>(urbanAggCities<span class="op">.</span><span class="fu">style</span>({</span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">'blue'</span><span class="op">,</span></span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'0000FF33'</span><span class="op">,</span></span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="dv">2</span></span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Selected Urban Agglomeration'</span>)<span class="op">;</span></span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>    MyMap<span class="op">.</span><span class="fu">centerObject</span>(urbanAggGeometry<span class="op">,</span> <span class="dv">6</span>)<span class="op">;</span></span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateStatus</span>(<span class="st">'Selected Urban Agglomeration：'</span> <span class="op">+</span> urbanAgg)<span class="op">;</span></span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a><span class="co">// Province</span></span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>provinceSelect<span class="op">.</span><span class="fu">onChange</span>(<span class="kw">function</span>(province) {</span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> urbanAgg <span class="op">=</span> urbanAggSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cities <span class="op">=</span> matchedCities</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a>      ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'UrbanAgg'</span><span class="op">,</span> urbanAgg)<span class="op">,</span></span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a>      ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_1'</span><span class="op">,</span> province)</span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">'NAME_2'</span>)</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">distinct</span>()</span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">sort</span>()<span class="op">;</span></span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>  cities<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(cityList) {</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>    citySelect<span class="op">.</span><span class="fu">items</span>()<span class="op">.</span><span class="fu">reset</span>(cityList)<span class="op">;</span></span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>    citySelect<span class="op">.</span><span class="fu">setValue</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (urbanAgg <span class="op">&amp;&amp;</span> province) {</span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> provinceCities <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>      ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'UrbanAgg'</span><span class="op">,</span> urbanAgg)<span class="op">,</span></span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>      ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_1'</span><span class="op">,</span> province)</span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a>    ))<span class="op">;</span></span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> provinceGeometry <span class="op">=</span> provinceCities<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> layers <span class="op">=</span> MyMap<span class="op">.</span><span class="fu">layers</span>()<span class="op">;</span></span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (layers<span class="op">.</span><span class="fu">length</span>() <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>      layers<span class="op">.</span><span class="fu">remove</span>(layers<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>    MyMap<span class="op">.</span><span class="fu">addLayer</span>(matchedCities<span class="op">.</span><span class="fu">style</span>({<span class="dt">color</span><span class="op">:</span> <span class="st">'gray'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'00000000'</span>})<span class="op">,</span> {}<span class="op">,</span> <span class="st">'urban boundary'</span>)<span class="op">;</span></span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>    MyMap<span class="op">.</span><span class="fu">addLayer</span>(provinceCities<span class="op">.</span><span class="fu">style</span>({</span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">'green'</span><span class="op">,</span></span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'00FF0033'</span><span class="op">,</span></span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="dv">2</span></span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Selected Province'</span>)<span class="op">;</span></span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>    MyMap<span class="op">.</span><span class="fu">centerObject</span>(provinceGeometry<span class="op">,</span> <span class="dv">7</span>)<span class="op">;</span></span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateStatus</span>(<span class="st">'Selected Province：'</span> <span class="op">+</span> province)<span class="op">;</span></span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a><span class="co">// City</span></span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>citySelect<span class="op">.</span><span class="fu">onChange</span>(<span class="kw">function</span>(city) {</span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> urbanAgg <span class="op">=</span> urbanAggSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> province <span class="op">=</span> provinceSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (urbanAgg <span class="op">&amp;&amp;</span> province <span class="op">&amp;&amp;</span> city) {</span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>    currentCityName <span class="op">=</span> city<span class="op">;</span></span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> cityFeature <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a>      ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'UrbanAgg'</span><span class="op">,</span> urbanAgg)<span class="op">,</span></span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a>      ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_1'</span><span class="op">,</span> province)<span class="op">,</span></span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a>      ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_2'</span><span class="op">,</span> city)</span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a>    ))<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a>    cityFeature<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(f) {</span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (f) {</span>
<span id="cb2-260"><a href="#cb2-260" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> cityGeom <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(f)<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb2-261"><a href="#cb2-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-262"><a href="#cb2-262" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> layers <span class="op">=</span> MyMap<span class="op">.</span><span class="fu">layers</span>()<span class="op">;</span></span>
<span id="cb2-263"><a href="#cb2-263" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> (layers<span class="op">.</span><span class="fu">length</span>() <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb2-264"><a href="#cb2-264" aria-hidden="true" tabindex="-1"></a>          layers<span class="op">.</span><span class="fu">remove</span>(layers<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb2-265"><a href="#cb2-265" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-266"><a href="#cb2-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-267"><a href="#cb2-267" aria-hidden="true" tabindex="-1"></a>        MyMap<span class="op">.</span><span class="fu">addLayer</span>(matchedCities<span class="op">.</span><span class="fu">style</span>({</span>
<span id="cb2-268"><a href="#cb2-268" aria-hidden="true" tabindex="-1"></a>          <span class="dt">color</span><span class="op">:</span> <span class="st">'gray'</span><span class="op">,</span></span>
<span id="cb2-269"><a href="#cb2-269" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'00000000'</span></span>
<span id="cb2-270"><a href="#cb2-270" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span> {}<span class="op">,</span> <span class="st">'urban boundary'</span>)<span class="op">;</span></span>
<span id="cb2-271"><a href="#cb2-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-272"><a href="#cb2-272" aria-hidden="true" tabindex="-1"></a>        MyMap<span class="op">.</span><span class="fu">addLayer</span>(ee<span class="op">.</span><span class="fu">FeatureCollection</span>(ee<span class="op">.</span><span class="fu">Feature</span>(f))<span class="op">.</span><span class="fu">style</span>({</span>
<span id="cb2-273"><a href="#cb2-273" aria-hidden="true" tabindex="-1"></a>          <span class="dt">color</span><span class="op">:</span> <span class="st">'red'</span><span class="op">,</span></span>
<span id="cb2-274"><a href="#cb2-274" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'FF000033'</span><span class="op">,</span></span>
<span id="cb2-275"><a href="#cb2-275" aria-hidden="true" tabindex="-1"></a>          <span class="dt">width</span><span class="op">:</span> <span class="dv">2</span></span>
<span id="cb2-276"><a href="#cb2-276" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Selected City'</span>)<span class="op">;</span></span>
<span id="cb2-277"><a href="#cb2-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-278"><a href="#cb2-278" aria-hidden="true" tabindex="-1"></a>        MyMap<span class="op">.</span><span class="fu">centerObject</span>(cityGeom<span class="op">,</span> <span class="dv">7</span>)<span class="op">;</span></span>
<span id="cb2-279"><a href="#cb2-279" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateStatus</span>(<span class="st">'Selected Province：'</span> <span class="op">+</span> city <span class="op">+</span> <span class="st">' (Click "Load City Data" to view the layer.)'</span>)<span class="op">;</span></span>
<span id="cb2-280"><a href="#cb2-280" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb2-281"><a href="#cb2-281" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateStatus</span>(<span class="st">'No city information found'</span>)<span class="op">;</span></span>
<span id="cb2-282"><a href="#cb2-282" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-283"><a href="#cb2-283" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb2-284"><a href="#cb2-284" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-285"><a href="#cb2-285" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-286"><a href="#cb2-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-287"><a href="#cb2-287" aria-hidden="true" tabindex="-1"></a><span class="co">// Creating an indicator selector</span></span>
<span id="cb2-288"><a href="#cb2-288" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> indicatorSelect <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb2-289"><a href="#cb2-289" aria-hidden="true" tabindex="-1"></a>  <span class="dt">items</span><span class="op">:</span> [</span>
<span id="cb2-290"><a href="#cb2-290" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">label</span><span class="op">:</span> <span class="st">'Net Carbon Sequestration'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">'NPP'</span>}<span class="op">,</span></span>
<span id="cb2-291"><a href="#cb2-291" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">label</span><span class="op">:</span> <span class="st">'WE (Water Use Effciency)'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">'WE'</span>}<span class="op">,</span></span>
<span id="cb2-292"><a href="#cb2-292" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">label</span><span class="op">:</span> <span class="st">'FPAR (Photosynthetically Active Radiation Absorption Ratio)'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">'FPAR'</span>}<span class="op">,</span></span>
<span id="cb2-293"><a href="#cb2-293" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">label</span><span class="op">:</span> <span class="st">'Energy Conversion Effciency'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">'Epsilon'</span>}<span class="op">,</span></span>
<span id="cb2-294"><a href="#cb2-294" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">label</span><span class="op">:</span> <span class="st">'Carbon Emission (CO₂)'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">'Emission'</span>}<span class="op">,</span></span>
<span id="cb2-295"><a href="#cb2-295" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">label</span><span class="op">:</span> <span class="st">'Carbon Sequestration (CO₂)'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">'CO2Absorption'</span>}<span class="op">,</span></span>
<span id="cb2-296"><a href="#cb2-296" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">label</span><span class="op">:</span> <span class="st">'Precipitation'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">'Rain'</span>}<span class="op">,</span></span>
<span id="cb2-297"><a href="#cb2-297" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">label</span><span class="op">:</span> <span class="st">'T (Temperature)'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">'Temperature'</span>}<span class="op">,</span></span>
<span id="cb2-298"><a href="#cb2-298" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">label</span><span class="op">:</span> <span class="st">'PAR (Photosynthetically Active Radiation)'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">'PAR'</span>}</span>
<span id="cb2-299"><a href="#cb2-299" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb2-300"><a href="#cb2-300" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">'NPP'</span><span class="op">,</span></span>
<span id="cb2-301"><a href="#cb2-301" aria-hidden="true" tabindex="-1"></a>  <span class="dt">placeholder</span><span class="op">:</span> <span class="st">'select an indicator'</span></span>
<span id="cb2-302"><a href="#cb2-302" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-303"><a href="#cb2-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-304"><a href="#cb2-304" aria-hidden="true" tabindex="-1"></a>indicatorSelect<span class="op">.</span><span class="fu">onChange</span>(<span class="kw">function</span>(indicator) {</span>
<span id="cb2-305"><a href="#cb2-305" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (currentCityName <span class="op">!==</span> <span class="kw">null</span>) {</span>
<span id="cb2-306"><a href="#cb2-306" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (indicatorChartWidget <span class="op">!==</span> <span class="kw">null</span>) {</span>
<span id="cb2-307"><a href="#cb2-307" aria-hidden="true" tabindex="-1"></a>      chartPanel<span class="op">.</span><span class="fu">remove</span>(indicatorChartWidget)<span class="op">;</span></span>
<span id="cb2-308"><a href="#cb2-308" aria-hidden="true" tabindex="-1"></a>      indicatorChartWidget <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb2-309"><a href="#cb2-309" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-310"><a href="#cb2-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-311"><a href="#cb2-311" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> cityFeature <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_2'</span><span class="op">,</span> currentCityName))<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb2-312"><a href="#cb2-312" aria-hidden="true" tabindex="-1"></a>    cityFeature<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(f){</span>
<span id="cb2-313"><a href="#cb2-313" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (f) {</span>
<span id="cb2-314"><a href="#cb2-314" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> cityGeom <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(f)<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb2-315"><a href="#cb2-315" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> selectedYear <span class="op">=</span> yearSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-316"><a href="#cb2-316" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> selectedMonth <span class="op">=</span> monthSlider<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-317"><a href="#cb2-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-318"><a href="#cb2-318" aria-hidden="true" tabindex="-1"></a>        indicatorChartWidget <span class="op">=</span> <span class="fu">plotCityIndicatorChart</span>(currentCityName<span class="op">,</span> cityGeom<span class="op">,</span> <span class="pp">parseInt</span>(selectedYear)<span class="op">,</span> indicator)<span class="op">;</span></span>
<span id="cb2-319"><a href="#cb2-319" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-320"><a href="#cb2-320" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb2-321"><a href="#cb2-321" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-322"><a href="#cb2-322" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-323"><a href="#cb2-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-324"><a href="#cb2-324" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> indicatorTipLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb2-325"><a href="#cb2-325" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">'Update will be shown in the last chart.'</span><span class="op">,</span></span>
<span id="cb2-326"><a href="#cb2-326" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb2-327"><a href="#cb2-327" aria-hidden="true" tabindex="-1"></a>    <span class="dt">fontSize</span><span class="op">:</span> <span class="st">'11px'</span><span class="op">,</span></span>
<span id="cb2-328"><a href="#cb2-328" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> <span class="st">'gray'</span><span class="op">,</span></span>
<span id="cb2-329"><a href="#cb2-329" aria-hidden="true" tabindex="-1"></a>    <span class="dt">margin</span><span class="op">:</span> <span class="st">'0 0 4px 10px'</span><span class="op">,</span></span>
<span id="cb2-330"><a href="#cb2-330" aria-hidden="true" tabindex="-1"></a>    <span class="dt">padding</span><span class="op">:</span> <span class="st">'0'</span></span>
<span id="cb2-331"><a href="#cb2-331" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-332"><a href="#cb2-332" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-333"><a href="#cb2-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-334"><a href="#cb2-334" aria-hidden="true" tabindex="-1"></a><span class="co">// "Load Urban Agglomeration Data" button</span></span>
<span id="cb2-335"><a href="#cb2-335" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> loadUrbanAggButton <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({</span>
<span id="cb2-336"><a href="#cb2-336" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">'Load Urban Agglomeration Data'</span><span class="op">,</span></span>
<span id="cb2-337"><a href="#cb2-337" aria-hidden="true" tabindex="-1"></a>  <span class="dt">onClick</span><span class="op">:</span> <span class="kw">function</span>() {</span>
<span id="cb2-338"><a href="#cb2-338" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> urbanAgg <span class="op">=</span> urbanAggSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-339"><a href="#cb2-339" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> year <span class="op">=</span> yearSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-340"><a href="#cb2-340" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (urbanAgg) {</span>
<span id="cb2-341"><a href="#cb2-341" aria-hidden="true" tabindex="-1"></a>      chartPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb2-342"><a href="#cb2-342" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> urbanAggCities <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'UrbanAgg'</span><span class="op">,</span> urbanAgg))<span class="op">;</span></span>
<span id="cb2-343"><a href="#cb2-343" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> urbanAggGeometry <span class="op">=</span> urbanAggCities<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb2-344"><a href="#cb2-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-345"><a href="#cb2-345" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plotUrbanAgglomerationCarbonChart</span>(urbanAgg<span class="op">,</span> urbanAggGeometry<span class="op">,</span> <span class="pp">parseInt</span>(year))<span class="op">;</span></span>
<span id="cb2-346"><a href="#cb2-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-347"><a href="#cb2-347" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateStatus</span>(<span class="st">'Loading Urban Agglomeration: '</span> <span class="op">+</span> urbanAgg)<span class="op">;</span></span>
<span id="cb2-348"><a href="#cb2-348" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb2-349"><a href="#cb2-349" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateStatus</span>(<span class="st">'Please select an urban agglomeration.'</span>)<span class="op">;</span></span>
<span id="cb2-350"><a href="#cb2-350" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-351"><a href="#cb2-351" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-352"><a href="#cb2-352" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-353"><a href="#cb2-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-354"><a href="#cb2-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-355"><a href="#cb2-355" aria-hidden="true" tabindex="-1"></a><span class="co">//“Load Provicne Data” button</span></span>
<span id="cb2-356"><a href="#cb2-356" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> loadProvinceButton <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({</span>
<span id="cb2-357"><a href="#cb2-357" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">'Load Province Data'</span><span class="op">,</span></span>
<span id="cb2-358"><a href="#cb2-358" aria-hidden="true" tabindex="-1"></a>  <span class="dt">onClick</span><span class="op">:</span> <span class="kw">function</span>() {</span>
<span id="cb2-359"><a href="#cb2-359" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> urbanAgg <span class="op">=</span> urbanAggSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-360"><a href="#cb2-360" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> province <span class="op">=</span> provinceSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-361"><a href="#cb2-361" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> year <span class="op">=</span> yearSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-362"><a href="#cb2-362" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (urbanAgg <span class="op">&amp;&amp;</span> province) {</span>
<span id="cb2-363"><a href="#cb2-363" aria-hidden="true" tabindex="-1"></a>      chartPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb2-364"><a href="#cb2-364" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> provinceGeom <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb2-365"><a href="#cb2-365" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'UrbanAgg'</span><span class="op">,</span> urbanAgg)<span class="op">,</span></span>
<span id="cb2-366"><a href="#cb2-366" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_1'</span><span class="op">,</span> province)</span>
<span id="cb2-367"><a href="#cb2-367" aria-hidden="true" tabindex="-1"></a>      ))<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb2-368"><a href="#cb2-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-369"><a href="#cb2-369" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plotProvinceCarbonChart</span>(province<span class="op">,</span> provinceGeom<span class="op">,</span> <span class="pp">parseInt</span>(year))<span class="op">;</span></span>
<span id="cb2-370"><a href="#cb2-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-371"><a href="#cb2-371" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateStatus</span>(<span class="st">'Loading Province: '</span> <span class="op">+</span> province)<span class="op">;</span></span>
<span id="cb2-372"><a href="#cb2-372" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb2-373"><a href="#cb2-373" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateStatus</span>(<span class="st">'Please select urban agglomeration and province first.'</span>)<span class="op">;</span></span>
<span id="cb2-374"><a href="#cb2-374" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-375"><a href="#cb2-375" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-376"><a href="#cb2-376" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-377"><a href="#cb2-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-378"><a href="#cb2-378" aria-hidden="true" tabindex="-1"></a><span class="co">// "Load City Data" button</span></span>
<span id="cb2-379"><a href="#cb2-379" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> loadFromSelectButton <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({</span>
<span id="cb2-380"><a href="#cb2-380" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">'Load City Data'</span><span class="op">,</span></span>
<span id="cb2-381"><a href="#cb2-381" aria-hidden="true" tabindex="-1"></a>  <span class="dt">onClick</span><span class="op">:</span> <span class="kw">function</span>() {</span>
<span id="cb2-382"><a href="#cb2-382" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> urbanAgg <span class="op">=</span> urbanAggSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-383"><a href="#cb2-383" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> province <span class="op">=</span> provinceSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-384"><a href="#cb2-384" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> city <span class="op">=</span> citySelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-385"><a href="#cb2-385" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> year <span class="op">=</span> yearSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-386"><a href="#cb2-386" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> month <span class="op">=</span> monthSlider<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-387"><a href="#cb2-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-388"><a href="#cb2-388" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (urbanAgg <span class="op">&amp;&amp;</span> province <span class="op">&amp;&amp;</span> city) {</span>
<span id="cb2-389"><a href="#cb2-389" aria-hidden="true" tabindex="-1"></a>      chartPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb2-390"><a href="#cb2-390" aria-hidden="true" tabindex="-1"></a>      currentCityName <span class="op">=</span> city<span class="op">;</span></span>
<span id="cb2-391"><a href="#cb2-391" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> cityGeom <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb2-392"><a href="#cb2-392" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'UrbanAgg'</span><span class="op">,</span> urbanAgg)<span class="op">,</span></span>
<span id="cb2-393"><a href="#cb2-393" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_1'</span><span class="op">,</span> province)<span class="op">,</span></span>
<span id="cb2-394"><a href="#cb2-394" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_2'</span><span class="op">,</span> city)</span>
<span id="cb2-395"><a href="#cb2-395" aria-hidden="true" tabindex="-1"></a>      ))<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb2-396"><a href="#cb2-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-397"><a href="#cb2-397" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateMap</span>(year<span class="op">,</span> cityGeom<span class="op">,</span> month)<span class="op">;</span></span>
<span id="cb2-398"><a href="#cb2-398" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plotSinglecityCarbonChart</span>(city<span class="op">,</span> cityGeom<span class="op">,</span> <span class="pp">parseInt</span>(year)<span class="op">,</span> month)</span>
<span id="cb2-399"><a href="#cb2-399" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">then</span>(<span class="kw">function</span>() {</span>
<span id="cb2-400"><a href="#cb2-400" aria-hidden="true" tabindex="-1"></a>  indicatorChartWidget <span class="op">=</span> <span class="fu">plotCityIndicatorChart</span>(city<span class="op">,</span> cityGeom<span class="op">,</span> <span class="pp">parseInt</span>(year)<span class="op">,</span> indicatorSelect<span class="op">.</span><span class="fu">getValue</span>())<span class="op">;</span></span>
<span id="cb2-401"><a href="#cb2-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateStatus</span>(<span class="st">'Loading City: '</span> <span class="op">+</span> city)<span class="op">;</span></span>
<span id="cb2-402"><a href="#cb2-402" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-403"><a href="#cb2-403" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb2-404"><a href="#cb2-404" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateStatus</span>(<span class="st">'Please select an urban agglomeration, province, and city.'</span>)<span class="op">;</span></span>
<span id="cb2-405"><a href="#cb2-405" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-406"><a href="#cb2-406" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-407"><a href="#cb2-407" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-408"><a href="#cb2-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-409"><a href="#cb2-409" aria-hidden="true" tabindex="-1"></a><span class="co">// Integrate controls into panels</span></span>
<span id="cb2-410"><a href="#cb2-410" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> controls <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb2-411"><a href="#cb2-411" aria-hidden="true" tabindex="-1"></a>  <span class="dt">widgets</span><span class="op">:</span> [</span>
<span id="cb2-412"><a href="#cb2-412" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Please select year'</span>)<span class="op">,</span> </span>
<span id="cb2-413"><a href="#cb2-413" aria-hidden="true" tabindex="-1"></a>    yearSelect<span class="op">,</span></span>
<span id="cb2-414"><a href="#cb2-414" aria-hidden="true" tabindex="-1"></a>    monthLabel<span class="op">,</span></span>
<span id="cb2-415"><a href="#cb2-415" aria-hidden="true" tabindex="-1"></a>    monthSlider<span class="op">,</span></span>
<span id="cb2-416"><a href="#cb2-416" aria-hidden="true" tabindex="-1"></a>    monthTipLabel<span class="op">,</span></span>
<span id="cb2-417"><a href="#cb2-417" aria-hidden="true" tabindex="-1"></a>    clearButton<span class="op">,</span></span>
<span id="cb2-418"><a href="#cb2-418" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Please select an urban agglomeration'</span>)<span class="op">,</span></span>
<span id="cb2-419"><a href="#cb2-419" aria-hidden="true" tabindex="-1"></a>    urbanAggSelect<span class="op">,</span> </span>
<span id="cb2-420"><a href="#cb2-420" aria-hidden="true" tabindex="-1"></a>    loadUrbanAggButton<span class="op">,</span></span>
<span id="cb2-421"><a href="#cb2-421" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Please select a province'</span>)<span class="op">,</span></span>
<span id="cb2-422"><a href="#cb2-422" aria-hidden="true" tabindex="-1"></a>    provinceSelect<span class="op">,</span></span>
<span id="cb2-423"><a href="#cb2-423" aria-hidden="true" tabindex="-1"></a>    loadProvinceButton<span class="op">,</span></span>
<span id="cb2-424"><a href="#cb2-424" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Please select a city'</span>)<span class="op">,</span></span>
<span id="cb2-425"><a href="#cb2-425" aria-hidden="true" tabindex="-1"></a>    citySelect<span class="op">,</span></span>
<span id="cb2-426"><a href="#cb2-426" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Please select an indicator'</span>)<span class="op">,</span></span>
<span id="cb2-427"><a href="#cb2-427" aria-hidden="true" tabindex="-1"></a>    indicatorSelect<span class="op">,</span></span>
<span id="cb2-428"><a href="#cb2-428" aria-hidden="true" tabindex="-1"></a>    indicatorTipLabel<span class="op">,</span></span>
<span id="cb2-429"><a href="#cb2-429" aria-hidden="true" tabindex="-1"></a>    loadFromSelectButton</span>
<span id="cb2-430"><a href="#cb2-430" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb2-431"><a href="#cb2-431" aria-hidden="true" tabindex="-1"></a>  <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'vertical'</span>)<span class="op">,</span></span>
<span id="cb2-432"><a href="#cb2-432" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb2-433"><a href="#cb2-433" aria-hidden="true" tabindex="-1"></a>    <span class="dt">margin</span><span class="op">:</span> <span class="st">'4px'</span><span class="op">,</span></span>
<span id="cb2-434"><a href="#cb2-434" aria-hidden="true" tabindex="-1"></a>    <span class="dt">padding</span><span class="op">:</span> <span class="st">'4px'</span></span>
<span id="cb2-435"><a href="#cb2-435" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-436"><a href="#cb2-436" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-437"><a href="#cb2-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-438"><a href="#cb2-438" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> sidebar <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb2-439"><a href="#cb2-439" aria-hidden="true" tabindex="-1"></a>  <span class="dt">widgets</span><span class="op">:</span> [</span>
<span id="cb2-440"><a href="#cb2-440" aria-hidden="true" tabindex="-1"></a>    statusLabel<span class="op">,</span></span>
<span id="cb2-441"><a href="#cb2-441" aria-hidden="true" tabindex="-1"></a>    controls</span>
<span id="cb2-442"><a href="#cb2-442" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb2-443"><a href="#cb2-443" aria-hidden="true" tabindex="-1"></a>  <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'vertical'</span>)<span class="op">,</span></span>
<span id="cb2-444"><a href="#cb2-444" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb2-445"><a href="#cb2-445" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="st">'290px'</span><span class="op">,</span></span>
<span id="cb2-446"><a href="#cb2-446" aria-hidden="true" tabindex="-1"></a>    <span class="dt">position</span><span class="op">:</span> <span class="st">'bottom-left'</span></span>
<span id="cb2-447"><a href="#cb2-447" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-448"><a href="#cb2-448" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-449"><a href="#cb2-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-450"><a href="#cb2-450" aria-hidden="true" tabindex="-1"></a><span class="co">// Define the right chart panel</span></span>
<span id="cb2-451"><a href="#cb2-451" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chartPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({  </span>
<span id="cb2-452"><a href="#cb2-452" aria-hidden="true" tabindex="-1"></a>  <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'vertical'</span>)<span class="op">,</span>  </span>
<span id="cb2-453"><a href="#cb2-453" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {  </span>
<span id="cb2-454"><a href="#cb2-454" aria-hidden="true" tabindex="-1"></a>    <span class="dt">position</span><span class="op">:</span> <span class="st">'top-right'</span><span class="op">,</span>  </span>
<span id="cb2-455"><a href="#cb2-455" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="st">'300px'</span><span class="op">,</span>    </span>
<span id="cb2-456"><a href="#cb2-456" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="st">'900'</span><span class="op">,</span>    </span>
<span id="cb2-457"><a href="#cb2-457" aria-hidden="true" tabindex="-1"></a>    <span class="dt">padding</span><span class="op">:</span> <span class="st">'10px'</span><span class="op">,</span>  </span>
<span id="cb2-458"><a href="#cb2-458" aria-hidden="true" tabindex="-1"></a>    <span class="dt">backgroundColor</span><span class="op">:</span> <span class="st">'rgba(255, 255, 255, 0.8)'</span><span class="op">,</span>  </span>
<span id="cb2-459"><a href="#cb2-459" aria-hidden="true" tabindex="-1"></a>    <span class="dt">border</span><span class="op">:</span> <span class="st">'1px solid black'</span>  </span>
<span id="cb2-460"><a href="#cb2-460" aria-hidden="true" tabindex="-1"></a>  }  </span>
<span id="cb2-461"><a href="#cb2-461" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span>  </span>
<span id="cb2-462"><a href="#cb2-462" aria-hidden="true" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">insert</span>(<span class="dv">1</span><span class="op">,</span> chartPanel)<span class="op">;</span>  </span>
<span id="cb2-463"><a href="#cb2-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-464"><a href="#cb2-464" aria-hidden="true" tabindex="-1"></a><span class="co">// Clear the interface again</span></span>
<span id="cb2-465"><a href="#cb2-465" aria-hidden="true" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb2-466"><a href="#cb2-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-467"><a href="#cb2-467" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a sidebar </span></span>
<span id="cb2-468"><a href="#cb2-468" aria-hidden="true" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(sidebar)<span class="op">;</span> </span>
<span id="cb2-469"><a href="#cb2-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-470"><a href="#cb2-470" aria-hidden="true" tabindex="-1"></a><span class="co">// Add Map (MyMap)</span></span>
<span id="cb2-471"><a href="#cb2-471" aria-hidden="true" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(MyMap)<span class="op">;</span></span>
<span id="cb2-472"><a href="#cb2-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-473"><a href="#cb2-473" aria-hidden="true" tabindex="-1"></a><span class="co">// Add chart area</span></span>
<span id="cb2-474"><a href="#cb2-474" aria-hidden="true" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(chartPanel)<span class="op">;</span></span>
<span id="cb2-475"><a href="#cb2-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-476"><a href="#cb2-476" aria-hidden="true" tabindex="-1"></a><span class="co">// =============== Map click interaction ================</span></span>
<span id="cb2-477"><a href="#cb2-477" aria-hidden="true" tabindex="-1"></a><span class="co">// Event Listener</span></span>
<span id="cb2-478"><a href="#cb2-478" aria-hidden="true" tabindex="-1"></a>MyMap<span class="op">.</span><span class="fu">onClick</span>(<span class="kw">function</span>(coords) {</span>
<span id="cb2-479"><a href="#cb2-479" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> point <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>(coords<span class="op">.</span><span class="at">lon</span><span class="op">,</span> coords<span class="op">.</span><span class="at">lat</span>)<span class="op">;</span></span>
<span id="cb2-480"><a href="#cb2-480" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> clickedFeature <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filterBounds</span>(point)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb2-481"><a href="#cb2-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-482"><a href="#cb2-482" aria-hidden="true" tabindex="-1"></a><span class="co">//Selecting City Event</span></span>
<span id="cb2-483"><a href="#cb2-483" aria-hidden="true" tabindex="-1"></a>  clickedFeature<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(f) {</span>
<span id="cb2-484"><a href="#cb2-484" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (f) {</span>
<span id="cb2-485"><a href="#cb2-485" aria-hidden="true" tabindex="-1"></a>  chartPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb2-486"><a href="#cb2-486" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> cityName <span class="op">=</span> f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">NAME_2</span><span class="op">;</span></span>
<span id="cb2-487"><a href="#cb2-487" aria-hidden="true" tabindex="-1"></a>      currentCityName <span class="op">=</span> cityName<span class="op">;</span></span>
<span id="cb2-488"><a href="#cb2-488" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> cityGeom <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">"NAME_2"</span><span class="op">,</span> cityName))<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb2-489"><a href="#cb2-489" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> selectedYear <span class="op">=</span> yearSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-490"><a href="#cb2-490" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> selectedMonth <span class="op">=</span> monthSlider<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-491"><a href="#cb2-491" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-492"><a href="#cb2-492" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateMap</span>(selectedYear<span class="op">,</span> cityGeom<span class="op">,</span> selectedMonth)<span class="op">;</span></span>
<span id="cb2-493"><a href="#cb2-493" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plotSinglecityCarbonChart</span>(cityName<span class="op">,</span> cityGeom<span class="op">,</span> <span class="pp">parseInt</span>(selectedYear)<span class="op">,</span> selectedMonth)</span>
<span id="cb2-494"><a href="#cb2-494" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">then</span>(<span class="kw">function</span>() {</span>
<span id="cb2-495"><a href="#cb2-495" aria-hidden="true" tabindex="-1"></a>        indicatorChartWidget <span class="op">=</span> <span class="fu">plotCityIndicatorChart</span>(cityName<span class="op">,</span> cityGeom<span class="op">,</span> <span class="pp">parseInt</span>(selectedYear)<span class="op">,</span> indicatorSelect<span class="op">.</span><span class="fu">getValue</span>())<span class="op">;</span></span>
<span id="cb2-496"><a href="#cb2-496" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateStatus</span>(<span class="st">'Click on the city: '</span> <span class="op">+</span> cityName)<span class="op">;</span></span>
<span id="cb2-497"><a href="#cb2-497" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-498"><a href="#cb2-498" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb2-499"><a href="#cb2-499" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateStatus</span>(<span class="st">'No city selected'</span>)<span class="op">;</span></span>
<span id="cb2-500"><a href="#cb2-500" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-501"><a href="#cb2-501" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-502"><a href="#cb2-502" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-503"><a href="#cb2-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-504"><a href="#cb2-504" aria-hidden="true" tabindex="-1"></a><span class="co">// Processing the selected year event</span></span>
<span id="cb2-505"><a href="#cb2-505" aria-hidden="true" tabindex="-1"></a>yearSelect<span class="op">.</span><span class="fu">onChange</span>(<span class="kw">function</span>(year) {</span>
<span id="cb2-506"><a href="#cb2-506" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (currentCityName <span class="op">!==</span> <span class="kw">null</span>) {</span>
<span id="cb2-507"><a href="#cb2-507" aria-hidden="true" tabindex="-1"></a>    chartPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb2-508"><a href="#cb2-508" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> cityFeature <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_2'</span><span class="op">,</span> currentCityName))<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb2-509"><a href="#cb2-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-510"><a href="#cb2-510" aria-hidden="true" tabindex="-1"></a>    cityFeature<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(f) {</span>
<span id="cb2-511"><a href="#cb2-511" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (f) {</span>
<span id="cb2-512"><a href="#cb2-512" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> cityGeom <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(f)<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb2-513"><a href="#cb2-513" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> selectedMonth <span class="op">=</span> monthSlider<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb2-514"><a href="#cb2-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-515"><a href="#cb2-515" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateMap</span>(year<span class="op">,</span> cityGeom<span class="op">,</span> selectedMonth)<span class="op">;</span></span>
<span id="cb2-516"><a href="#cb2-516" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plotSinglecityCarbon</span>(currentCityName<span class="op">,</span> cityGeom<span class="op">,</span> <span class="pp">parseInt</span>(year)<span class="op">,</span> selectedMonth)<span class="op">;</span></span>
<span id="cb2-517"><a href="#cb2-517" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plotCityIndicatorChart</span>(currentCityName<span class="op">,</span> cityGeom<span class="op">,</span> <span class="pp">parseInt</span>(year)<span class="op">,</span> indicatorSelect<span class="op">.</span><span class="fu">getValue</span>())<span class="op">;</span></span>
<span id="cb2-518"><a href="#cb2-518" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateStatus</span>(<span class="st">'Year switching: '</span> <span class="op">+</span> year)<span class="op">;</span></span>
<span id="cb2-519"><a href="#cb2-519" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb2-520"><a href="#cb2-520" aria-hidden="true" tabindex="-1"></a>        <span class="fu">updateStatus</span>(<span class="st">'City information not found'</span>)<span class="op">;</span></span>
<span id="cb2-521"><a href="#cb2-521" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-522"><a href="#cb2-522" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb2-523"><a href="#cb2-523" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-524"><a href="#cb2-524" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="data-processing-and-analysis" class="level3">
<h3 class="anchored" data-anchor-id="data-processing-and-analysis"><strong>3.</strong> Data Processing and Analysis</h3>
<p>In this section, the researchers combine the city, year, and month parameters to dynamically extract and process nighttime light, meteorological, and vegetation related data, completing the calculation of core indicators such as CO₂ emissions, CO₂ sequestration, and net CO₂ emissions. The specific calculation method has been explained in detail in the Methodology section above.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// =============== Main plotting function ================</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Set visualization parameters</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> viirsVis <span class="op">=</span> {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="fl">50.0</span><span class="op">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'black'</span><span class="op">,</span><span class="st">'darkblue'</span><span class="op">,</span><span class="st">'blue'</span><span class="op">,</span><span class="st">'purple'</span><span class="op">,</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cyan'</span><span class="op">,</span><span class="st">'green'</span><span class="op">,</span><span class="st">'yellow'</span><span class="op">,</span><span class="st">'white'</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ncVis <span class="op">=</span> {</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">10000</span><span class="op">,</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">'green'</span><span class="op">,</span><span class="st">'yellow'</span><span class="op">,</span><span class="st">'red'</span>]</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Fuction of carbon emissions</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> computeNCitj <span class="op">=</span> <span class="kw">function</span>(feature) {</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> region <span class="op">=</span> feature<span class="op">.</span><span class="fu">getString</span>(<span class="st">'region'</span>)<span class="op">;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> DN     <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(feature<span class="op">.</span><span class="fu">get</span>(<span class="st">'averageDNitj'</span>))<span class="op">;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> Vit    <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(feature<span class="op">.</span><span class="fu">get</span>(<span class="st">'Vit'</span>))<span class="op">;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    DN<span class="op">.</span><span class="fu">lte</span>(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    feature<span class="op">,</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">function</span>() {</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> log_DN <span class="op">=</span> DN<span class="op">.</span><span class="fu">log</span>()<span class="op">;</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> log_NCitj <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        region<span class="op">.</span><span class="fu">equals</span>(<span class="st">'eastern'</span>)<span class="op">,</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        log_DN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">1.0484</span>)<span class="op">.</span><span class="fu">add</span>(Vit<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">6.1871</span>))<span class="op">,</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>          region<span class="op">.</span><span class="fu">equals</span>(<span class="st">'central'</span>)<span class="op">,</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>          log_DN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.8773</span>)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">4.2414</span>)<span class="op">,</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>            region<span class="op">.</span><span class="fu">equals</span>(<span class="st">'western'</span>)<span class="op">,</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>            log_DN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.3645</span>)<span class="op">.</span><span class="fu">add</span>(Vit<span class="op">.</span><span class="fu">add</span>(<span class="fl">2.2189</span>))<span class="op">,</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>            <span class="kw">null</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> feature<span class="op">.</span><span class="fu">set</span>(<span class="st">'NCitj'</span><span class="op">,</span> ee<span class="op">.</span><span class="fu">Number</span>(log_NCitj)<span class="op">.</span><span class="fu">exp</span>())<span class="op">;</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    })()</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Update the display content of the map</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">updateMap</span>(year<span class="op">,</span> geometry<span class="op">,</span> month) {</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> layers <span class="op">=</span> MyMap<span class="op">.</span><span class="fu">layers</span>()<span class="op">;</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (layers<span class="op">.</span><span class="fu">length</span>() <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  layers<span class="op">.</span><span class="fu">remove</span>(layers<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>  allLegendPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> startDate<span class="op">,</span> endDate<span class="op">;</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (month <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="pp">parseInt</span>(year)<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="pp">parseInt</span>(year)<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)<span class="op">;</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthInt <span class="op">=</span> <span class="pp">parseInt</span>(month)<span class="op">;</span>  </span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="pp">parseInt</span>(year)<span class="op">,</span> monthInt<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">'month'</span>)<span class="op">;</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>  MyMap<span class="op">.</span><span class="fu">addLayer</span>(matchedCities<span class="op">.</span><span class="fu">style</span>({<span class="dt">color</span><span class="op">:</span> <span class="st">'gray'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'00000000'</span>})<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Boundary of the research area'</span>)<span class="op">;</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="co">//  Nighttime Light Image Collection (year)</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> viirs <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'NOAA/VIIRS/DNB/MONTHLY_V1/VCMSLCFG'</span>)</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filterDate</span>(startDate<span class="op">,</span> endDate)</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">select</span>(<span class="st">'avg_rad'</span>)         <span class="co">// Select the average emissivity band</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">mean</span>()   </span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="co">// Layer (year)</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cityFeature <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filterBounds</span>(geometry)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> region <span class="op">=</span> cityFeature<span class="op">.</span><span class="fu">get</span>(<span class="st">'region'</span>)<span class="op">;</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> Vit <span class="op">=</span> cityFeature<span class="op">.</span><span class="fu">get</span>(<span class="st">'Vit'</span>)<span class="op">;</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> viirsLight <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'NOAA/VIIRS/DNB/MONTHLY_V1/VCMSLCFG'</span>)</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filterDate</span>(startDate<span class="op">,</span> endDate)</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">'avg_rad'</span>)</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a><span class="co">// Average Nighttime Light</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> meanDN <span class="op">=</span> viirsLight<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">get</span>(<span class="st">'avg_rad'</span>)<span class="op">;</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a><span class="co">// Handling missing values</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>meanDN <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(meanDN<span class="op">,</span> meanDN<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> logDN <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(meanDN)<span class="op">.</span><span class="fu">log</span>()<span class="op">;</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate carbon emissions by region</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> logNCitj <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>  ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'eastern'</span>)<span class="op">,</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>  logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">1.0484</span>)<span class="op">.</span><span class="fu">add</span>(ee<span class="op">.</span><span class="fu">Number</span>(Vit)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">6.1871</span>))<span class="op">,</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>  ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>    ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'central'</span>)<span class="op">,</span></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>    logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.8773</span>)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">4.2414</span>)<span class="op">,</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>      ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'western'</span>)<span class="op">,</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>      logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.3645</span>)<span class="op">.</span><span class="fu">add</span>(ee<span class="op">.</span><span class="fu">Number</span>(Vit)<span class="op">.</span><span class="fu">add</span>(<span class="fl">2.2189</span>))<span class="op">,</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>      <span class="dv">0</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a><span class="co">// Estimating total carbon emissions</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> NCitj <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(logNCitj)<span class="op">.</span><span class="fu">exp</span>()<span class="op">;</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cityArea <span class="op">=</span> geometry<span class="op">.</span><span class="fu">area</span>()<span class="op">;</span>  <span class="co">// m²</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> emission <span class="op">=</span> NCitj<span class="op">.</span><span class="fu">multiply</span>(cityArea)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">250000</span>)<span class="op">;</span>  <span class="co">// Ten thousand tons CO₂</span></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> viirsVis <span class="op">=</span> {        <span class="co">// Visualization</span></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>    <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>    <span class="dt">max</span><span class="op">:</span> <span class="fl">50.0</span><span class="op">,</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>    <span class="dt">palette</span><span class="op">:</span> [</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>      <span class="st">'black'</span><span class="op">,</span> <span class="st">'darkblue'</span><span class="op">,</span> <span class="st">'blue'</span><span class="op">,</span> <span class="st">'purple'</span><span class="op">,</span></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>      <span class="st">'cyan'</span><span class="op">,</span> <span class="st">'green'</span><span class="op">,</span> <span class="st">'yellow'</span><span class="op">,</span> <span class="st">'white'</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> safeDN <span class="op">=</span> viirs<span class="op">.</span><span class="fu">where</span>(viirs<span class="op">.</span><span class="fu">lte</span>(<span class="dv">0</span>)<span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> logDNimg <span class="op">=</span> safeDN<span class="op">.</span><span class="fu">log</span>()<span class="op">;</span></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a><span class="co">// Regional coefficient layer</span></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> regionStr <span class="op">=</span> ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">;</span></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> VitSafe <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(Vit<span class="op">,</span> Vit<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> a_val <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>    regionStr<span class="op">.</span><span class="fu">equals</span>(<span class="st">'eastern'</span>)<span class="op">,</span> <span class="fl">1.0484</span><span class="op">,</span></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(regionStr<span class="op">.</span><span class="fu">equals</span>(<span class="st">'central'</span>)<span class="op">,</span> <span class="fl">0.8773</span><span class="op">,</span> <span class="fl">0.3645</span>)</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> b_val <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>    regionStr<span class="op">.</span><span class="fu">equals</span>(<span class="st">'eastern'</span>)<span class="op">,</span> ee<span class="op">.</span><span class="fu">Number</span>(VitSafe)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">6.1871</span>)<span class="op">,</span></span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(regionStr<span class="op">.</span><span class="fu">equals</span>(<span class="st">'central'</span>)<span class="op">,</span> <span class="op">-</span><span class="fl">4.2414</span><span class="op">,</span> ee<span class="op">.</span><span class="fu">Number</span>(VitSafe)<span class="op">.</span><span class="fu">add</span>(<span class="fl">2.2189</span>))</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> a_img <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(a_val)<span class="op">;</span></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> b_img <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(b_val)<span class="op">;</span></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> logNCitj <span class="op">=</span> logDNimg<span class="op">.</span><span class="fu">multiply</span>(a_img)<span class="op">.</span><span class="fu">add</span>(b_img)<span class="op">;</span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> emissionImage <span class="op">=</span> logNCitj<span class="op">.</span><span class="fu">exp</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">1e10</span>)<span class="op">;</span>  </span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> pixelArea <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>()<span class="op">;</span>   <span class="co">// Convert units to:(g/m²)</span></span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>  emissionImage <span class="op">=</span> emissionImage<span class="op">.</span><span class="fu">divide</span>(pixelArea)<span class="op">;</span>  </span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a><span class="co">// Define Carbon Emissions Palette</span></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> carbonPalette <span class="op">=</span> [</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#ffffcc'</span><span class="op">,</span> <span class="st">'#ffeda0'</span><span class="op">,</span> <span class="st">'#fed976'</span><span class="op">,</span> <span class="st">'#feb24c'</span><span class="op">,</span> <span class="st">'#fd8d3c'</span><span class="op">,</span></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#fc4e2a'</span><span class="op">,</span> <span class="st">'#e31a1c'</span><span class="op">,</span> <span class="st">'#bd0026'</span><span class="op">,</span> <span class="st">'#800026'</span><span class="op">,</span> <span class="st">'#4d0019'</span><span class="op">,</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#2b000f'</span><span class="op">,</span> <span class="st">'#67001f'</span><span class="op">,</span> <span class="st">'#99003f'</span><span class="op">,</span> <span class="st">'#b2182b'</span><span class="op">,</span> <span class="st">'#d73027'</span></span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a><span class="co">// Regional visualization scope (g/m²)</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> visParams <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>({</span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>    <span class="st">'eastern'</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span>}<span class="op">,</span></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>    <span class="st">'central'</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">4000</span>}<span class="op">,</span></span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>    <span class="st">'western'</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">5000</span>}</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a><span class="co">// NPP/FPAR/Epsilon/WE</span></span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'NASA/FLDAS/NOAH01/C/GL/M/V001'</span>)</span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filterDate</span>(startDate<span class="op">,</span> endDate)</span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> rain_temp_par <span class="op">=</span> dataset<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>    <span class="st">'rain * 60 * 60 * 24 * 30'</span><span class="op">,</span> {<span class="st">'rain'</span><span class="op">:</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">'Rainf_f_tavg'</span>)}</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>  )<span class="op">.</span><span class="fu">rename</span>(<span class="st">'rain'</span>)</span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>   <span class="op">.</span><span class="fu">addBands</span>(dataset<span class="op">.</span><span class="fu">expression</span>(<span class="st">'temp - 273.15'</span><span class="op">,</span> {<span class="st">'temp'</span><span class="op">:</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">'Tair_f_tavg'</span>)})<span class="op">.</span><span class="fu">rename</span>(<span class="st">'temp'</span>))</span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>   <span class="op">.</span><span class="fu">addBands</span>(dataset<span class="op">.</span><span class="fu">expression</span>(<span class="st">'rad * 60 * 60 * 24 * 30 / 1e6 * 0.5'</span><span class="op">,</span> {<span class="st">'rad'</span><span class="op">:</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">'Swnet_tavg'</span>)})<span class="op">.</span><span class="fu">rename</span>(<span class="st">'par'</span>))<span class="op">;</span></span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'MODIS/061/MOD13A2'</span>)</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filterDate</span>(startDate<span class="op">,</span> endDate)</span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">select</span>(<span class="st">'NDVI'</span>)</span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> ndvi_pro <span class="op">=</span> ndvi<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">;</span></span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> SR <span class="op">=</span> ndvi_pro<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(ndvi_pro))<span class="op">.</span><span class="fu">rename</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> SR_min <span class="op">=</span> SR<span class="op">.</span><span class="fu">reduceRegion</span>({<span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span>})<span class="op">.</span><span class="fu">get</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> SR_max <span class="op">=</span> SR<span class="op">.</span><span class="fu">reduceRegion</span>({<span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span>})<span class="op">.</span><span class="fu">get</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> FPAR <span class="op">=</span> SR<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_min))<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_max)<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_min)))<span class="op">.</span><span class="fu">clamp</span>(<span class="dv">0</span><span class="op">,</span> <span class="fl">0.95</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'FPAR'</span>)<span class="op">;</span></span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> FPAR_filled <span class="op">=</span> FPAR<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(FPAR)<span class="op">;</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> evapCollection <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(</span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>    year <span class="op">&lt;=</span> <span class="dv">2020</span> <span class="op">?</span> <span class="st">'MODIS/061/MOD16A2GF'</span> <span class="op">:</span> <span class="st">'MODIS/061/MOD16A2'</span></span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> evap <span class="op">=</span> evapCollection</span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filterDate</span>(startDate<span class="op">,</span> endDate)</span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">select</span>([<span class="st">'ET'</span><span class="op">,</span> <span class="st">'PET'</span>])<span class="op">;</span></span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> WE <span class="op">=</span> evap<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a>    <span class="st">'0.5 * ((0.5 + E) / Ep)'</span><span class="op">,</span> {</span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a>      <span class="st">'E'</span><span class="op">:</span> evap<span class="op">.</span><span class="fu">select</span>(<span class="st">'ET'</span>)<span class="op">,</span></span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Ep'</span><span class="op">:</span> evap<span class="op">.</span><span class="fu">select</span>(<span class="st">'PET'</span>)</span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">rename</span>(<span class="st">'WE'</span>)<span class="op">;</span></span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> WE_filled <span class="op">=</span> WE<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(WE)<span class="op">;</span></span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> T_opt <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'temp'</span>)<span class="op">;</span></span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> Te1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">0.8</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.027</span>))<span class="op">.</span><span class="fu">subtract</span>(T_opt<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00005</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">'Te1'</span>)<span class="op">;</span></span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> Te2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">1.184</span>)</span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">subtract</span>(T_opt)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.2</span>)<span class="op">.</span><span class="fu">exp</span>()))</span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">add</span>(T_opt)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.3</span>)<span class="op">.</span><span class="fu">exp</span>())))</span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">rename</span>(<span class="st">'Te2'</span>)<span class="op">;</span></span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> epsilon <span class="op">=</span> Te1<span class="op">.</span><span class="fu">multiply</span>(Te2)<span class="op">.</span><span class="fu">multiply</span>(WE_filled)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.95</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'epsilon'</span>)<span class="op">;</span></span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> epsilon_filled <span class="op">=</span> epsilon<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(epsilon)<span class="op">;</span></span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> common_mask <span class="op">=</span> FPAR_filled<span class="op">.</span><span class="fu">mask</span>()</span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">and</span>(epsilon_filled<span class="op">.</span><span class="fu">mask</span>())</span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">and</span>(WE_filled<span class="op">.</span><span class="fu">mask</span>())</span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">and</span>(rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'par'</span>)<span class="op">.</span><span class="fu">mask</span>())<span class="op">;</span></span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> par_masked <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'par'</span>)<span class="op">.</span><span class="fu">updateMask</span>(common_mask)<span class="op">;</span></span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> NPP <span class="op">=</span> par_masked<span class="op">.</span><span class="fu">multiply</span>(FPAR_filled)<span class="op">.</span><span class="fu">multiply</span>(epsilon_filled)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'NPP'</span>)<span class="op">;</span></span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> CO2_absorption <span class="op">=</span> NPP<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">3.6667</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'CO2_absorption'</span>)<span class="op">;</span> <span class="co">// Carbon sequestration CO₂</span></span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate net carbon dioxide emissions: carbon dioxide emissions - carbon dioxide sequestration</span></span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> netEmission <span class="op">=</span> emissionImage<span class="op">.</span><span class="fu">subtract</span>(CO2_absorption)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'netEmission'</span>)<span class="op">;</span></span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a>  MyMap<span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">7</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="map-layers" class="level3">
<h3 class="anchored" data-anchor-id="map-layers"><strong>4. Map</strong> Layers</h3>
<p>This section analyzes and displays the calculated results in a layered format, including nighttime light intensity, CO₂ emissions, CO₂ sequestration , net CO₂ emissions, NPP, WE, FPAR, and Epsilon. Users can switch between different indicator layers with one click through the interface, intuitively observing the spatial distribution characteristics and differences of CO₂ emissions and sequestration .</p>
<p>Note: In the color matching design of the <strong>Carbon Sequestration CO₂ layer</strong>, a segmented color matching strategy combined with gradient color depth was adopted. Specifically, different color segments (orange-blue-green) are used to quickly distinguish the overall level of carbon sequestration; The gradient inside each color segment is further subdivided into intensity changes, allowing users to accurately perceive differences within the same level. In the <strong>Net CO₂ emissions layer</strong>, cool colors (green series) are used to represent carbon sequestration, warm colors (yellow to red series) are used to represent carbon emissions, and white is used as a bidirectional symmetrical color band structure with zero emissions, intuitively showing whether the city is a carbon source or sink.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// =========== Add Layer ==============</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">// WE Layer</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  MyMap<span class="op">.</span><span class="fu">addLayer</span>(WE_filled<span class="op">.</span><span class="fu">updateMask</span>(common_mask)<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">'white'</span><span class="op">,</span> <span class="st">'blue'</span>]}<span class="op">,</span> <span class="st">'WE'</span>)<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  allLegendPanel<span class="op">.</span><span class="fu">add</span>(<span class="fu">createLegendBox</span>(<span class="st">'WE'</span><span class="op">,</span> [<span class="st">'white'</span><span class="op">,</span> <span class="st">'blue'</span>]<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">// NPP Layer</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  MyMap<span class="op">.</span><span class="fu">addLayer</span>(NPP<span class="op">,</span> {</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 0 = white</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#ffffff'</span><span class="op">,</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// &gt;0–3：Orange → Deep Red, Level 10 Gradient</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#fee8c8'</span><span class="op">,</span> <span class="st">'#fdd49e'</span><span class="op">,</span> <span class="st">'#fdbb84'</span><span class="op">,</span> <span class="st">'#fc8d59'</span><span class="op">,</span> <span class="st">'#ef6548'</span><span class="op">,</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#d7301f'</span><span class="op">,</span> <span class="st">'#c1271a'</span><span class="op">,</span> <span class="st">'#bd0026'</span><span class="op">,</span> <span class="st">'#99000d'</span><span class="op">,</span> <span class="st">'#67000d'</span><span class="op">,</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3–6：Blue → Purple</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#deebf7'</span><span class="op">,</span> <span class="st">'#9ecae1'</span><span class="op">,</span> <span class="st">'#3182bd'</span><span class="op">,</span> <span class="st">'#6a51a3'</span><span class="op">,</span> <span class="st">'#54278f'</span><span class="op">,</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 6–10：Light green → Dark green</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#e5f5e0'</span><span class="op">,</span> <span class="st">'#a1d99b'</span><span class="op">,</span> <span class="st">'#31a354'</span><span class="op">,</span> <span class="st">'#006d2c'</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> <span class="st">'NPP'</span>)<span class="op">;</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  allLegendPanel<span class="op">.</span><span class="fu">add</span>(<span class="fu">createLegendBox</span>(<span class="st">'NPP (gC/m²)'</span><span class="op">,</span> [</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#ffffff'</span><span class="op">,</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#fee8c8'</span><span class="op">,</span> <span class="st">'#fdd49e'</span><span class="op">,</span> <span class="st">'#fdbb84'</span><span class="op">,</span> <span class="st">'#fc8d59'</span><span class="op">,</span> <span class="st">'#ef6548'</span><span class="op">,</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#d7301f'</span><span class="op">,</span> <span class="st">'#c1271a'</span><span class="op">,</span> <span class="st">'#bd0026'</span><span class="op">,</span> <span class="st">'#99000d'</span><span class="op">,</span> <span class="st">'#67000d'</span><span class="op">,</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#deebf7'</span><span class="op">,</span> <span class="st">'#9ecae1'</span><span class="op">,</span> <span class="st">'#3182bd'</span><span class="op">,</span> <span class="st">'#6a51a3'</span><span class="op">,</span> <span class="st">'#54278f'</span><span class="op">,</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#e5f5e0'</span><span class="op">,</span> <span class="st">'#a1d99b'</span><span class="op">,</span> <span class="st">'#31a354'</span><span class="op">,</span> <span class="st">'#006d2c'</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">10</span>))<span class="op">;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="co">// NPP layer projection information</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateStatus</span>(<span class="st">'Carbon dioxide sequestration layer projection:'</span><span class="op">,</span> CO2_absorption<span class="op">.</span><span class="fu">projection</span>())<span class="op">;</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateStatus</span>(<span class="st">'Carbon dioxide sequestration layer nominal scale (m):'</span><span class="op">,</span> CO2_absorption<span class="op">.</span><span class="fu">projection</span>()<span class="op">.</span><span class="fu">nominalScale</span>())<span class="op">;</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateStatus</span>(<span class="st">'Carbon dioxide emission layer projection:'</span><span class="op">,</span> emissionImage<span class="op">.</span><span class="fu">projection</span>())<span class="op">;</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateStatus</span>(<span class="st">'Carbon dioxide emission layer nominal scale (m):'</span><span class="op">,</span> emissionImage<span class="op">.</span><span class="fu">projection</span>()<span class="op">.</span><span class="fu">nominalScale</span>())<span class="op">;</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co">// Epsilon Layer</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  MyMap<span class="op">.</span><span class="fu">addLayer</span>(epsilon_filled<span class="op">.</span><span class="fu">updateMask</span>(common_mask)<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">'purple'</span><span class="op">,</span> <span class="st">'blue'</span><span class="op">,</span> <span class="st">'green'</span>]}<span class="op">,</span> <span class="st">'Epsilon'</span>)<span class="op">;</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  allLegendPanel<span class="op">.</span><span class="fu">add</span>(<span class="fu">createLegendBox</span>(<span class="st">'Epsilon'</span><span class="op">,</span> [<span class="st">'purple'</span><span class="op">,</span> <span class="st">'blue'</span><span class="op">,</span> <span class="st">'green'</span>]<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="fl">0.5</span>))<span class="op">;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co">// FPAR Layer</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  MyMap<span class="op">.</span><span class="fu">addLayer</span>(FPAR_filled<span class="op">.</span><span class="fu">updateMask</span>(common_mask)<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.95</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">'yellow'</span><span class="op">,</span> <span class="st">'orange'</span><span class="op">,</span> <span class="st">'red'</span>]}<span class="op">,</span> <span class="st">'FPAR'</span>)<span class="op">;</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>  allLegendPanel<span class="op">.</span><span class="fu">add</span>(<span class="fu">createLegendBox</span>(<span class="st">'FPAR'</span><span class="op">,</span> [<span class="st">'yellow'</span><span class="op">,</span> <span class="st">'orange'</span><span class="op">,</span> <span class="st">'red'</span>]<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="fl">0.95</span>))<span class="op">;</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Nighttime Light Layer</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  MyMap<span class="op">.</span><span class="fu">addLayer</span>(viirs<span class="op">,</span> viirsVis<span class="op">,</span> <span class="st">'Night-time Lights'</span>)<span class="op">;</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  allLegendPanel<span class="op">.</span><span class="fu">add</span>(<span class="fu">createLegendBox</span>(<span class="st">'Nighttime light intensity'</span><span class="op">,</span> viirsVis<span class="op">.</span><span class="at">palette</span><span class="op">,</span> viirsVis<span class="op">.</span><span class="at">min</span><span class="op">,</span> viirsVis<span class="op">.</span><span class="at">max</span>))<span class="op">;</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="co">// Carbon sequestration CO₂ Layer</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>MyMap<span class="op">.</span><span class="fu">addLayer</span>(CO2_absorption<span class="op">,</span> {</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span>   </span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 0 = white</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#ffffff'</span><span class="op">,</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// &gt;0–3：Orange → Deep Red, Level 10 Gradient</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#fee8c8'</span><span class="op">,</span> <span class="st">'#fdd49e'</span><span class="op">,</span> <span class="st">'#fdbb84'</span><span class="op">,</span> <span class="st">'#fc8d59'</span><span class="op">,</span> <span class="st">'#ef6548'</span><span class="op">,</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#d7301f'</span><span class="op">,</span> <span class="st">'#c1271a'</span><span class="op">,</span> <span class="st">'#bd0026'</span><span class="op">,</span> <span class="st">'#99000d'</span><span class="op">,</span> <span class="st">'#67000d'</span><span class="op">,</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3–6：Blue → Purple</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#deebf7'</span><span class="op">,</span> <span class="st">'#9ecae1'</span><span class="op">,</span> <span class="st">'#3182bd'</span><span class="op">,</span> <span class="st">'#6a51a3'</span><span class="op">,</span> <span class="st">'#54278f'</span><span class="op">,</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 6–10：Light green → Dark green</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#e5f5e0'</span><span class="op">,</span> <span class="st">'#a1d99b'</span><span class="op">,</span> <span class="st">'#31a354'</span><span class="op">,</span> <span class="st">'#006d2c'</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> <span class="st">'Carbon sequestration (CO₂)'</span>)<span class="op">;</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>  allLegendPanel<span class="op">.</span><span class="fu">add</span>(<span class="fu">createLegendBox</span>(<span class="st">'Carbon sequestration (CO₂)'</span><span class="op">,</span> [</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#ffffff'</span><span class="op">,</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#fee8c8'</span><span class="op">,</span> <span class="st">'#fdd49e'</span><span class="op">,</span> <span class="st">'#fdbb84'</span><span class="op">,</span> <span class="st">'#fc8d59'</span><span class="op">,</span> <span class="st">'#ef6548'</span><span class="op">,</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#d7301f'</span><span class="op">,</span> <span class="st">'#c1271a'</span><span class="op">,</span> <span class="st">'#bd0026'</span><span class="op">,</span> <span class="st">'#99000d'</span><span class="op">,</span> <span class="st">'#67000d'</span><span class="op">,</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#deebf7'</span><span class="op">,</span> <span class="st">'#9ecae1'</span><span class="op">,</span> <span class="st">'#3182bd'</span><span class="op">,</span> <span class="st">'#6a51a3'</span><span class="op">,</span> <span class="st">'#54278f'</span><span class="op">,</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#e5f5e0'</span><span class="op">,</span> <span class="st">'#a1d99b'</span><span class="op">,</span> <span class="st">'#31a354'</span><span class="op">,</span> <span class="st">'#006d2c'</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">30</span>))<span class="op">;</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a><span class="co">// CO₂ Emissions Layer</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> selectedVis <span class="op">=</span> visParams<span class="op">.</span><span class="fu">get</span>(regionStr)<span class="op">.</span><span class="fu">getInfo</span>()<span class="op">;</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>  MyMap<span class="op">.</span><span class="fu">addLayer</span>(emissionImage<span class="op">,</span> {</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="dt">min</span><span class="op">:</span> selectedVis<span class="op">.</span><span class="at">min</span><span class="op">,</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="dt">max</span><span class="op">:</span> selectedVis<span class="op">.</span><span class="at">max</span><span class="op">,</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    <span class="dt">palette</span><span class="op">:</span> carbonPalette</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> <span class="st">'Carbon Emissions (CO₂)'</span>)<span class="op">;</span> <span class="co">//(g/m²)</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>  allLegendPanel<span class="op">.</span><span class="fu">add</span>(<span class="fu">createLegendBox</span>(<span class="st">'Carbon Emissions (CO₂)'</span><span class="op">,</span> carbonPalette<span class="op">,</span> selectedVis<span class="op">.</span><span class="at">min</span><span class="op">,</span> selectedVis<span class="op">.</span><span class="at">max</span>))<span class="op">;</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a><span class="co">// Net carbon dioxide emission layer</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> netEmissionPalette <span class="op">=</span> [</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#e5f5e0'</span><span class="op">,</span> <span class="st">'#a1d99b'</span><span class="op">,</span> <span class="st">'#31a354'</span><span class="op">,</span> <span class="st">'#006d2c'</span><span class="op">,</span>  <span class="co">// Negative value (sequestration)</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#ffffff'</span><span class="op">,</span>                                   <span class="co">// 0 (white)</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#ffffcc'</span><span class="op">,</span> <span class="st">'#ffeda0'</span><span class="op">,</span> <span class="st">'#fed976'</span><span class="op">,</span> <span class="st">'#feb24c'</span><span class="op">,</span>  <span class="co">// Positive value (Light emissions)</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#fd8d3c'</span><span class="op">,</span> <span class="st">'#fc4e2a'</span><span class="op">,</span> <span class="st">'#e31a1c'</span><span class="op">,</span> <span class="st">'#bd0026'</span><span class="op">,</span> <span class="st">'#800026'</span>  <span class="co">// Positive value (Heavy emissions)</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>  MyMap<span class="op">.</span><span class="fu">addLayer</span>(netEmission<span class="op">,</span> {</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>    <span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">50</span><span class="op">,</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    <span class="dt">max</span><span class="op">:</span> <span class="dv">200</span><span class="op">,</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>    <span class="dt">palette</span><span class="op">:</span> netEmissionPalette</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> <span class="st">'Net CO₂ emissions (g/m²)'</span>)<span class="op">;</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>  allLegendPanel<span class="op">.</span><span class="fu">add</span>(<span class="fu">createLegendBox</span>(<span class="st">'Net CO₂ emissions (g/m²)'</span><span class="op">,</span> netEmissionPalette<span class="op">,</span> <span class="op">-</span><span class="dv">50</span><span class="op">,</span> <span class="dv">200</span>))<span class="op">;</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="chart-drawing" class="level3">
<h3 class="anchored" data-anchor-id="chart-drawing"><strong>5.</strong> Chart Drawing</h3>
<p>This section presents line charts of monthly CO₂ emissions, CO₂ sequestration, and net CO₂ emissions trends at different spatial scales (cities, provinces, urban agglomerations) over a year. In addition, the researchers also add a pie chart of the proportion of net CO₂ emissions of cities in urban agglomerations.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// =============== Line Chart Visualization ================</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">// figure1: average values of each indicator in cities</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plotCityIndicatorChart</span>(cityName<span class="op">,</span> geometry<span class="op">,</span> year<span class="op">,</span> indicator) {</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  indicator <span class="op">=</span> indicator <span class="op">||</span> <span class="st">'NPP'</span><span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cityArea <span class="op">=</span> geometry<span class="op">.</span><span class="fu">area</span>()<span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cityFeature <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filterBounds</span>(geometry)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> region <span class="op">=</span> cityFeature<span class="op">.</span><span class="fu">get</span>(<span class="st">'region'</span>)<span class="op">;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> Vit <span class="op">=</span> cityFeature<span class="op">.</span><span class="fu">get</span>(<span class="st">'Vit'</span>)<span class="op">;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> monthlyData <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(m) {</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> start <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> m<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> end <span class="op">=</span> start<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">'month'</span>)<span class="op">;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> fldas <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'NASA/FLDAS/NOAH01/C/GL/M/V001'</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">first</span>()</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> ndvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'MODIS/061/MOD13A2'</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(<span class="st">'NDVI'</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">first</span>()</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> nightLight <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'NOAA/VIIRS/DNB/MONTHLY_V1/VCMSLCFG'</span>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">first</span>()</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> evapCollection <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>      year <span class="op">&lt;=</span> <span class="dv">2020</span> <span class="op">?</span> <span class="st">'MODIS/061/MOD16A2GF'</span> <span class="op">:</span> <span class="st">'MODIS/061/MOD16A2'</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> evap <span class="op">=</span> evapCollection</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">first</span>()</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(fldas <span class="op">&amp;&amp;</span> ndvi <span class="op">&amp;&amp;</span> nightLight <span class="op">&amp;&amp;</span> evap<span class="op">,</span> (<span class="kw">function</span>() {</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> rain_temp_par <span class="op">=</span> fldas<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rain * 60 * 60 * 24 * 30'</span><span class="op">,</span> {<span class="st">'rain'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Rainf_f_tavg'</span>)}</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>      )<span class="op">.</span><span class="fu">rename</span>(<span class="st">'rain'</span>)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">addBands</span>(fldas<span class="op">.</span><span class="fu">expression</span>(<span class="st">'temp - 273.15'</span><span class="op">,</span> {<span class="st">'temp'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Tair_f_tavg'</span>)})<span class="op">.</span><span class="fu">rename</span>(<span class="st">'temp'</span>))</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">addBands</span>(fldas<span class="op">.</span><span class="fu">expression</span>(<span class="st">'rad * 60 * 60 * 24 * 30 / 1e6 * 0.5'</span><span class="op">,</span> {<span class="st">'rad'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Swnet_tavg'</span>)})<span class="op">.</span><span class="fu">rename</span>(<span class="st">'par'</span>))<span class="op">;</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> ndvi_pro <span class="op">=</span> ndvi<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">;</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> SR <span class="op">=</span> ndvi_pro<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(ndvi_pro))<span class="op">.</span><span class="fu">rename</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> SR_min <span class="op">=</span> SR<span class="op">.</span><span class="fu">reduceRegion</span>({<span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span>})<span class="op">.</span><span class="fu">get</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> SR_max <span class="op">=</span> SR<span class="op">.</span><span class="fu">reduceRegion</span>({<span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span>})<span class="op">.</span><span class="fu">get</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> FPAR <span class="op">=</span> SR<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_min))</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_max)<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_min)))</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">clamp</span>(<span class="dv">0</span><span class="op">,</span> <span class="fl">0.95</span>)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">rename</span>(<span class="st">'FPAR'</span>)<span class="op">;</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> FPAR_filled <span class="op">=</span> FPAR<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(FPAR)<span class="op">;</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> WE <span class="op">=</span> evap<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">'0.5 * ((0.5 + E) / Ep)'</span><span class="op">,</span> {</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>          <span class="st">'E'</span><span class="op">:</span> evap<span class="op">.</span><span class="fu">select</span>(<span class="st">'ET'</span>)<span class="op">,</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>          <span class="st">'Ep'</span><span class="op">:</span> evap<span class="op">.</span><span class="fu">select</span>(<span class="st">'PET'</span>)</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        })<span class="op">.</span><span class="fu">rename</span>(<span class="st">'WE'</span>)<span class="op">;</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> WE_filled <span class="op">=</span> WE<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(WE)<span class="op">;</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> T_opt <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'temp'</span>)<span class="op">;</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> Te1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">0.8</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.027</span>))<span class="op">.</span><span class="fu">subtract</span>(T_opt<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00005</span>))<span class="op">;</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> Te2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">1.184</span>)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">subtract</span>(T_opt)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.2</span>)<span class="op">.</span><span class="fu">exp</span>()))</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">add</span>(T_opt)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.3</span>)<span class="op">.</span><span class="fu">exp</span>())))<span class="op">;</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> epsilon <span class="op">=</span> Te1<span class="op">.</span><span class="fu">multiply</span>(Te2)<span class="op">.</span><span class="fu">multiply</span>(WE_filled)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.95</span>)<span class="op">;</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> epsilon_filled <span class="op">=</span> epsilon<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(epsilon)<span class="op">;</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> common_mask <span class="op">=</span> FPAR_filled<span class="op">.</span><span class="fu">mask</span>()</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">and</span>(epsilon_filled<span class="op">.</span><span class="fu">mask</span>())</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">and</span>(WE_filled<span class="op">.</span><span class="fu">mask</span>())</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">and</span>(rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'par'</span>)<span class="op">.</span><span class="fu">mask</span>())<span class="op">;</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> par_masked <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'par'</span>)<span class="op">.</span><span class="fu">updateMask</span>(common_mask)<span class="op">;</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> NPP <span class="op">=</span> par_masked<span class="op">.</span><span class="fu">multiply</span>(FPAR_filled)<span class="op">.</span><span class="fu">multiply</span>(epsilon_filled)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'NPP'</span>)<span class="op">;</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> safeDN <span class="op">=</span> nightLight<span class="op">.</span><span class="fu">select</span>(<span class="st">'avg_rad'</span>)<span class="op">.</span><span class="fu">where</span>(nightLight<span class="op">.</span><span class="fu">select</span>(<span class="st">'avg_rad'</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">0</span>)<span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> logDNimg <span class="op">=</span> safeDN<span class="op">.</span><span class="fu">log</span>()<span class="op">;</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> regionStr <span class="op">=</span> ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">;</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> VitSafe <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(Vit<span class="op">,</span> Vit<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> a_val <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>        regionStr<span class="op">.</span><span class="fu">equals</span>(<span class="st">'eastern'</span>)<span class="op">,</span> <span class="fl">1.0484</span><span class="op">,</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(regionStr<span class="op">.</span><span class="fu">equals</span>(<span class="st">'central'</span>)<span class="op">,</span> <span class="fl">0.8773</span><span class="op">,</span> <span class="fl">0.3645</span>)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> b_val <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>        regionStr<span class="op">.</span><span class="fu">equals</span>(<span class="st">'eastern'</span>)<span class="op">,</span> ee<span class="op">.</span><span class="fu">Number</span>(VitSafe)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">6.1871</span>)<span class="op">,</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(regionStr<span class="op">.</span><span class="fu">equals</span>(<span class="st">'central'</span>)<span class="op">,</span> <span class="op">-</span><span class="fl">4.2414</span><span class="op">,</span> ee<span class="op">.</span><span class="fu">Number</span>(VitSafe)<span class="op">.</span><span class="fu">add</span>(<span class="fl">2.2189</span>))</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> a_img <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(a_val)<span class="op">;</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> b_img <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(b_val)<span class="op">;</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> logNCitj <span class="op">=</span> logDNimg<span class="op">.</span><span class="fu">multiply</span>(a_img)<span class="op">.</span><span class="fu">add</span>(b_img)<span class="op">;</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> emissionImage <span class="op">=</span> logNCitj<span class="op">.</span><span class="fu">exp</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">1e10</span>)<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())<span class="op">;</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> CO2_absorption <span class="op">=</span> NPP<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">3.6667</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'CO2_absorption'</span>)<span class="op">;</span></span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> targetImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (indicator <span class="op">===</span> <span class="st">'NPP'</span>) {</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>        targetImage <span class="op">=</span> NPP<span class="op">;</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator <span class="op">===</span> <span class="st">'WE'</span>) {</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>        targetImage <span class="op">=</span> WE_filled<span class="op">;</span></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator <span class="op">===</span> <span class="st">'FPAR'</span>) {</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>        targetImage <span class="op">=</span> FPAR_filled<span class="op">;</span></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator <span class="op">===</span> <span class="st">'Epsilon'</span>) {</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>        targetImage <span class="op">=</span> epsilon_filled<span class="op">;</span></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator <span class="op">===</span> <span class="st">'Emission'</span>) {</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>        targetImage <span class="op">=</span> emissionImage<span class="op">;</span></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator <span class="op">===</span> <span class="st">'CO2Absorption'</span>) {</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>        targetImage <span class="op">=</span> CO2_absorption<span class="op">;</span></span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator <span class="op">===</span> <span class="st">'Rain'</span>) {</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>        targetImage <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'rain'</span>)<span class="op">;</span></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator <span class="op">===</span> <span class="st">'Temperature'</span>) {</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>        targetImage <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'temp'</span>)<span class="op">;</span></span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (indicator <span class="op">===</span> <span class="st">'PAR'</span>) {</span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>        targetImage <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'par'</span>)<span class="op">;</span></span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> meanValue <span class="op">=</span> targetImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>        <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>        <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>        <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>        <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>      })<span class="op">.</span><span class="fu">values</span>()<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>meanValue <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(meanValue<span class="op">,</span> meanValue<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>        <span class="st">'month'</span><span class="op">:</span> m<span class="op">,</span></span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>        <span class="st">'value'</span><span class="op">:</span> meanValue<span class="op">,</span></span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>        <span class="st">'city'</span><span class="op">:</span> cityName</span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>    })()<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> featureCol <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(monthlyData)</span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">notNull</span>([<span class="st">'value'</span>]))</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">sort</span>(<span class="st">'month'</span>)<span class="op">;</span></span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> indicatorUnits <span class="op">=</span> {</span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>  <span class="st">'NPP'</span><span class="op">:</span> <span class="st">'gC/m²'</span><span class="op">,</span></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>  <span class="st">'WE'</span><span class="op">:</span> <span class="st">''</span><span class="op">,</span></span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a>  <span class="st">'FPAR'</span><span class="op">:</span> <span class="st">''</span><span class="op">,</span></span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Epsilon'</span><span class="op">:</span> <span class="st">''</span><span class="op">,</span> </span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Emission'</span><span class="op">:</span> <span class="st">'gCO₂/m²'</span><span class="op">,</span></span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>  <span class="st">'CO2Absorption'</span><span class="op">:</span> <span class="st">'gCO₂/m²'</span><span class="op">,</span></span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Rain'</span><span class="op">:</span> <span class="st">'mm/month'</span><span class="op">,</span></span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Temperature'</span><span class="op">:</span> <span class="st">'°C'</span><span class="op">,</span></span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>  <span class="st">'PAR'</span><span class="op">:</span> <span class="st">'MJ/m²/month'</span></span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> unit <span class="op">=</span> indicatorUnits[indicator] <span class="op">||</span> <span class="st">''</span><span class="op">;</span></span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byFeature</span>(featureCol<span class="op">,</span> <span class="st">'month'</span><span class="op">,</span> <span class="st">'value'</span>)</span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">setChartType</span>(<span class="st">'LineChart'</span>)</span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span>   <span class="st">'Monthly Average Values of '</span><span class="op">+</span> indicator <span class="op">+</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span> <span class="op">+</span> cityName <span class="op">+</span> <span class="st">'（'</span> <span class="op">+</span> year <span class="op">+</span> <span class="st">'）'</span><span class="op">,</span></span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">'month'</span>}<span class="op">,</span></span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">'Average Values of'</span><span class="op">+</span> indicator <span class="op">+</span> unit}<span class="op">,</span></span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a>      <span class="dt">height</span><span class="op">:</span> <span class="dv">152</span><span class="op">,</span></span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">'none'</span>}</span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>  chartPanel<span class="op">.</span><span class="fu">add</span>(chart)<span class="op">;</span></span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> chart<span class="op">;</span></span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a><span class="co">// figure2: Total carbon emisssions,sequestration,netemisssions amount in agglomerations (10ktons CO₂)</span></span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plotUrbanAgglomerationCarbonChart</span>(urbanAggName<span class="op">,</span> geometry<span class="op">,</span> year) {</span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cityArea <span class="op">=</span> geometry<span class="op">.</span><span class="fu">area</span>()<span class="op">;</span></span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sampleCity <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'UrbanAgg'</span><span class="op">,</span> urbanAggName))<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> region <span class="op">=</span> sampleCity<span class="op">.</span><span class="fu">get</span>(<span class="st">'region'</span>)<span class="op">;</span></span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> Vit <span class="op">=</span> sampleCity<span class="op">.</span><span class="fu">get</span>(<span class="st">'Vit'</span>)<span class="op">;</span></span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> monthly <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(m) {</span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> start <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> m<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> end <span class="op">=</span> start<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">'month'</span>)<span class="op">;</span></span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> nightLight <span class="op">=</span> dataset<span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> fldas <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'NASA/FLDAS/NOAH01/C/GL/M/V001'</span>)</span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> ndvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'MODIS/061/MOD13A2'</span>)</span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">select</span>(<span class="st">'NDVI'</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> evapCollection <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(</span>
<span id="cb5-205"><a href="#cb5-205" aria-hidden="true" tabindex="-1"></a>      year <span class="op">&lt;=</span> <span class="dv">2020</span> <span class="op">?</span> <span class="st">'MODIS/061/MOD16A2GF'</span> <span class="op">:</span> <span class="st">'MODIS/061/MOD16A2'</span></span>
<span id="cb5-206"><a href="#cb5-206" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> evap <span class="op">=</span> evapCollection<span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(nightLight <span class="op">&amp;&amp;</span> fldas <span class="op">&amp;&amp;</span> ndvi <span class="op">&amp;&amp;</span> evap<span class="op">,</span> (<span class="kw">function</span>() {</span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> meanDN <span class="op">=</span> nightLight<span class="op">.</span><span class="fu">select</span>(<span class="st">'avg_rad'</span>)<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a>        <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a>        <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a>        <span class="dt">scale</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a>        <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a>      })<span class="op">.</span><span class="fu">get</span>(<span class="st">'avg_rad'</span>)<span class="op">;</span></span>
<span id="cb5-216"><a href="#cb5-216" aria-hidden="true" tabindex="-1"></a>      meanDN <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(meanDN<span class="op">,</span> meanDN<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-217"><a href="#cb5-217" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> logDN <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(meanDN)<span class="op">.</span><span class="fu">log</span>()<span class="op">;</span></span>
<span id="cb5-218"><a href="#cb5-218" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> logNCitj <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-219"><a href="#cb5-219" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'eastern'</span>)<span class="op">,</span></span>
<span id="cb5-220"><a href="#cb5-220" aria-hidden="true" tabindex="-1"></a>        logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">1.0484</span>)<span class="op">.</span><span class="fu">add</span>(ee<span class="op">.</span><span class="fu">Number</span>(Vit)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">6.1871</span>))<span class="op">,</span></span>
<span id="cb5-221"><a href="#cb5-221" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-222"><a href="#cb5-222" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'central'</span>)<span class="op">,</span></span>
<span id="cb5-223"><a href="#cb5-223" aria-hidden="true" tabindex="-1"></a>          logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.8773</span>)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">4.2414</span>)<span class="op">,</span></span>
<span id="cb5-224"><a href="#cb5-224" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-225"><a href="#cb5-225" aria-hidden="true" tabindex="-1"></a>            ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'western'</span>)<span class="op">,</span></span>
<span id="cb5-226"><a href="#cb5-226" aria-hidden="true" tabindex="-1"></a>            logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.3645</span>)<span class="op">.</span><span class="fu">add</span>(ee<span class="op">.</span><span class="fu">Number</span>(Vit)<span class="op">.</span><span class="fu">add</span>(<span class="fl">2.2189</span>))<span class="op">,</span></span>
<span id="cb5-227"><a href="#cb5-227" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span></span>
<span id="cb5-228"><a href="#cb5-228" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb5-229"><a href="#cb5-229" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-230"><a href="#cb5-230" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb5-231"><a href="#cb5-231" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> NCitj <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(logNCitj)<span class="op">.</span><span class="fu">exp</span>()<span class="op">;</span></span>
<span id="cb5-232"><a href="#cb5-232" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> emission <span class="op">=</span> NCitj<span class="op">.</span><span class="fu">multiply</span>(cityArea)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">250000</span>)<span class="op">;</span></span>
<span id="cb5-233"><a href="#cb5-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-234"><a href="#cb5-234" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> rain_temp_par <span class="op">=</span> fldas<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb5-235"><a href="#cb5-235" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rain * 60 * 60 * 24 * 30'</span><span class="op">,</span> {<span class="st">'rain'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Rainf_f_tavg'</span>)}</span>
<span id="cb5-236"><a href="#cb5-236" aria-hidden="true" tabindex="-1"></a>      )<span class="op">.</span><span class="fu">rename</span>(<span class="st">'rain'</span>)</span>
<span id="cb5-237"><a href="#cb5-237" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">addBands</span>(fldas<span class="op">.</span><span class="fu">expression</span>(<span class="st">'temp - 273.15'</span><span class="op">,</span> {<span class="st">'temp'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Tair_f_tavg'</span>)})<span class="op">.</span><span class="fu">rename</span>(<span class="st">'temp'</span>))</span>
<span id="cb5-238"><a href="#cb5-238" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">addBands</span>(fldas<span class="op">.</span><span class="fu">expression</span>(<span class="st">'rad * 60 * 60 * 24 * 30 / 1e6 * 0.5'</span><span class="op">,</span> {<span class="st">'rad'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Swnet_tavg'</span>)})<span class="op">.</span><span class="fu">rename</span>(<span class="st">'par'</span>))<span class="op">;</span></span>
<span id="cb5-239"><a href="#cb5-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-240"><a href="#cb5-240" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> ndvi_pro <span class="op">=</span> ndvi<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">;</span></span>
<span id="cb5-241"><a href="#cb5-241" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> SR <span class="op">=</span> ndvi_pro<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(ndvi_pro))<span class="op">.</span><span class="fu">rename</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-242"><a href="#cb5-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-243"><a href="#cb5-243" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> SR_min <span class="op">=</span> SR<span class="op">.</span><span class="fu">reduceRegion</span>({<span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span>})<span class="op">.</span><span class="fu">get</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-244"><a href="#cb5-244" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> SR_max <span class="op">=</span> SR<span class="op">.</span><span class="fu">reduceRegion</span>({<span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span>})<span class="op">.</span><span class="fu">get</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-245"><a href="#cb5-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-246"><a href="#cb5-246" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> FPAR <span class="op">=</span> SR<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_min))<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_max)<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_min)))<span class="op">.</span><span class="fu">clamp</span>(<span class="dv">0</span><span class="op">,</span> <span class="fl">0.95</span>)<span class="op">;</span></span>
<span id="cb5-247"><a href="#cb5-247" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> FPAR_filled <span class="op">=</span> FPAR<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(FPAR)<span class="op">;</span></span>
<span id="cb5-248"><a href="#cb5-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-249"><a href="#cb5-249" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> WE <span class="op">=</span> evap<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb5-250"><a href="#cb5-250" aria-hidden="true" tabindex="-1"></a>        <span class="st">'0.5 * ((0.5 + E) / Ep)'</span><span class="op">,</span> {</span>
<span id="cb5-251"><a href="#cb5-251" aria-hidden="true" tabindex="-1"></a>          <span class="st">'E'</span><span class="op">:</span> evap<span class="op">.</span><span class="fu">select</span>(<span class="st">'ET'</span>)<span class="op">,</span></span>
<span id="cb5-252"><a href="#cb5-252" aria-hidden="true" tabindex="-1"></a>          <span class="st">'Ep'</span><span class="op">:</span> evap<span class="op">.</span><span class="fu">select</span>(<span class="st">'PET'</span>)</span>
<span id="cb5-253"><a href="#cb5-253" aria-hidden="true" tabindex="-1"></a>        })<span class="op">.</span><span class="fu">rename</span>(<span class="st">'WE'</span>)<span class="op">;</span></span>
<span id="cb5-254"><a href="#cb5-254" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> WE_filled <span class="op">=</span> WE<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(WE)<span class="op">;</span></span>
<span id="cb5-255"><a href="#cb5-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-256"><a href="#cb5-256" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> T_opt <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'temp'</span>)<span class="op">;</span></span>
<span id="cb5-257"><a href="#cb5-257" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> Te1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">0.8</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.027</span>))<span class="op">.</span><span class="fu">subtract</span>(T_opt<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00005</span>))<span class="op">;</span></span>
<span id="cb5-258"><a href="#cb5-258" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> Te2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">1.184</span>)</span>
<span id="cb5-259"><a href="#cb5-259" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">subtract</span>(T_opt)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.2</span>)<span class="op">.</span><span class="fu">exp</span>()))</span>
<span id="cb5-260"><a href="#cb5-260" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">add</span>(T_opt)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.3</span>)<span class="op">.</span><span class="fu">exp</span>())))<span class="op">;</span></span>
<span id="cb5-261"><a href="#cb5-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-262"><a href="#cb5-262" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> epsilon <span class="op">=</span> Te1<span class="op">.</span><span class="fu">multiply</span>(Te2)<span class="op">.</span><span class="fu">multiply</span>(WE_filled)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.95</span>)<span class="op">;</span></span>
<span id="cb5-263"><a href="#cb5-263" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> epsilon_filled <span class="op">=</span> epsilon<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(epsilon)<span class="op">;</span></span>
<span id="cb5-264"><a href="#cb5-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-265"><a href="#cb5-265" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> common_mask <span class="op">=</span> FPAR_filled<span class="op">.</span><span class="fu">mask</span>()</span>
<span id="cb5-266"><a href="#cb5-266" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">and</span>(epsilon_filled<span class="op">.</span><span class="fu">mask</span>())</span>
<span id="cb5-267"><a href="#cb5-267" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">and</span>(WE_filled<span class="op">.</span><span class="fu">mask</span>())</span>
<span id="cb5-268"><a href="#cb5-268" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">and</span>(rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'par'</span>)<span class="op">.</span><span class="fu">mask</span>())<span class="op">;</span></span>
<span id="cb5-269"><a href="#cb5-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-270"><a href="#cb5-270" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> par_masked <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'par'</span>)<span class="op">.</span><span class="fu">updateMask</span>(common_mask)<span class="op">;</span></span>
<span id="cb5-271"><a href="#cb5-271" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> NPP <span class="op">=</span> par_masked<span class="op">.</span><span class="fu">multiply</span>(FPAR_filled)<span class="op">.</span><span class="fu">multiply</span>(epsilon_filled)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'NPP'</span>)<span class="op">;</span></span>
<span id="cb5-272"><a href="#cb5-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-273"><a href="#cb5-273" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> meanNPP <span class="op">=</span> NPP<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb5-274"><a href="#cb5-274" aria-hidden="true" tabindex="-1"></a>        <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb5-275"><a href="#cb5-275" aria-hidden="true" tabindex="-1"></a>        <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb5-276"><a href="#cb5-276" aria-hidden="true" tabindex="-1"></a>        <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb5-277"><a href="#cb5-277" aria-hidden="true" tabindex="-1"></a>        <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb5-278"><a href="#cb5-278" aria-hidden="true" tabindex="-1"></a>      })<span class="op">.</span><span class="fu">get</span>(<span class="st">'NPP'</span>)<span class="op">;</span></span>
<span id="cb5-279"><a href="#cb5-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-280"><a href="#cb5-280" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> totalCarbon_g <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(meanNPP)<span class="op">.</span><span class="fu">multiply</span>(cityArea)<span class="op">;</span></span>
<span id="cb5-281"><a href="#cb5-281" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> totalCO2_g <span class="op">=</span> totalCarbon_g<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">44</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb5-282"><a href="#cb5-282" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> totalCO2_kt <span class="op">=</span> totalCO2_g<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e8</span>)<span class="op">;</span></span>
<span id="cb5-283"><a href="#cb5-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-284"><a href="#cb5-284" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> netEmission <span class="op">=</span> emission<span class="op">.</span><span class="fu">subtract</span>(totalCO2_kt)<span class="op">;</span></span>
<span id="cb5-285"><a href="#cb5-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-286"><a href="#cb5-286" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {</span>
<span id="cb5-287"><a href="#cb5-287" aria-hidden="true" tabindex="-1"></a>        <span class="st">'month'</span><span class="op">:</span> m<span class="op">,</span></span>
<span id="cb5-288"><a href="#cb5-288" aria-hidden="true" tabindex="-1"></a>        <span class="st">'emission'</span><span class="op">:</span> emission<span class="op">,</span></span>
<span id="cb5-289"><a href="#cb5-289" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sequestration'</span><span class="op">:</span> totalCO2_kt<span class="op">,</span></span>
<span id="cb5-290"><a href="#cb5-290" aria-hidden="true" tabindex="-1"></a>        <span class="st">'netEmission'</span><span class="op">:</span> netEmission</span>
<span id="cb5-291"><a href="#cb5-291" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb5-292"><a href="#cb5-292" aria-hidden="true" tabindex="-1"></a>    })()<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb5-293"><a href="#cb5-293" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb5-294"><a href="#cb5-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-295"><a href="#cb5-295" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> fc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(monthly)</span>
<span id="cb5-296"><a href="#cb5-296" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">notNull</span>([<span class="st">'emission'</span>]))</span>
<span id="cb5-297"><a href="#cb5-297" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">sort</span>(<span class="st">'month'</span>)<span class="op">;</span></span>
<span id="cb5-298"><a href="#cb5-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-299"><a href="#cb5-299" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byFeature</span>(fc<span class="op">,</span> <span class="st">'month'</span><span class="op">,</span> [<span class="st">'emission'</span><span class="op">,</span> <span class="st">'sequestration'</span><span class="op">,</span> <span class="st">'netEmission'</span>])</span>
<span id="cb5-300"><a href="#cb5-300" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">setChartType</span>(<span class="st">'LineChart'</span>)</span>
<span id="cb5-301"><a href="#cb5-301" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb5-302"><a href="#cb5-302" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">'Monthly Carbon Emission / Sequestration / Net Emission</span><span class="sc">\n</span><span class="st">'</span> <span class="op">+</span> urbanAggName <span class="op">+</span> <span class="st">'（'</span> <span class="op">+</span> year <span class="op">+</span> <span class="st">'）'</span><span class="op">,</span></span>
<span id="cb5-303"><a href="#cb5-303" aria-hidden="true" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">'Month'</span>}<span class="op">,</span></span>
<span id="cb5-304"><a href="#cb5-304" aria-hidden="true" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">'Amount (10ktons CO₂)'</span>}<span class="op">,</span></span>
<span id="cb5-305"><a href="#cb5-305" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb5-306"><a href="#cb5-306" aria-hidden="true" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb5-307"><a href="#cb5-307" aria-hidden="true" tabindex="-1"></a>      <span class="dt">height</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb5-308"><a href="#cb5-308" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">'bottom'</span>}</span>
<span id="cb5-309"><a href="#cb5-309" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb5-310"><a href="#cb5-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-311"><a href="#cb5-311" aria-hidden="true" tabindex="-1"></a>  chartPanel<span class="op">.</span><span class="fu">add</span>(chart)<span class="op">;</span></span>
<span id="cb5-312"><a href="#cb5-312" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-313"><a href="#cb5-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-314"><a href="#cb5-314" aria-hidden="true" tabindex="-1"></a><span class="co">// figure3: Total carbon emisssions,sequestration,netemisssions amount in provinces (10ktons CO₂)</span></span>
<span id="cb5-315"><a href="#cb5-315" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plotProvinceCarbonChart</span>(provinceName<span class="op">,</span> geometry<span class="op">,</span> year) {</span>
<span id="cb5-316"><a href="#cb5-316" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb5-317"><a href="#cb5-317" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cityArea <span class="op">=</span> geometry<span class="op">.</span><span class="fu">area</span>()<span class="op">;</span></span>
<span id="cb5-318"><a href="#cb5-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-319"><a href="#cb5-319" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sampleCity <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_1'</span><span class="op">,</span> provinceName))<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-320"><a href="#cb5-320" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> region <span class="op">=</span> sampleCity<span class="op">.</span><span class="fu">get</span>(<span class="st">'region'</span>)<span class="op">;</span></span>
<span id="cb5-321"><a href="#cb5-321" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> Vit <span class="op">=</span> sampleCity<span class="op">.</span><span class="fu">get</span>(<span class="st">'Vit'</span>)<span class="op">;</span></span>
<span id="cb5-322"><a href="#cb5-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-323"><a href="#cb5-323" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> monthly <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(m) {</span>
<span id="cb5-324"><a href="#cb5-324" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> start <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> m<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb5-325"><a href="#cb5-325" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> end <span class="op">=</span> start<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">'month'</span>)<span class="op">;</span></span>
<span id="cb5-326"><a href="#cb5-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-327"><a href="#cb5-327" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> nightLight <span class="op">=</span> dataset<span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb5-328"><a href="#cb5-328" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> fldas <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'NASA/FLDAS/NOAH01/C/GL/M/V001'</span>)</span>
<span id="cb5-329"><a href="#cb5-329" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-330"><a href="#cb5-330" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> ndvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'MODIS/061/MOD13A2'</span>)</span>
<span id="cb5-331"><a href="#cb5-331" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">select</span>(<span class="st">'NDVI'</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-332"><a href="#cb5-332" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> evapCollection <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(</span>
<span id="cb5-333"><a href="#cb5-333" aria-hidden="true" tabindex="-1"></a>      year <span class="op">&lt;=</span> <span class="dv">2020</span> <span class="op">?</span> <span class="st">'MODIS/061/MOD16A2GF'</span> <span class="op">:</span> <span class="st">'MODIS/061/MOD16A2'</span></span>
<span id="cb5-334"><a href="#cb5-334" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb5-335"><a href="#cb5-335" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> evap <span class="op">=</span> evapCollection<span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-336"><a href="#cb5-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-337"><a href="#cb5-337" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(nightLight <span class="op">&amp;&amp;</span> fldas <span class="op">&amp;&amp;</span> ndvi <span class="op">&amp;&amp;</span> evap<span class="op">,</span> (<span class="kw">function</span>() {</span>
<span id="cb5-338"><a href="#cb5-338" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> meanDN <span class="op">=</span> nightLight<span class="op">.</span><span class="fu">select</span>(<span class="st">'avg_rad'</span>)<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb5-339"><a href="#cb5-339" aria-hidden="true" tabindex="-1"></a>        <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb5-340"><a href="#cb5-340" aria-hidden="true" tabindex="-1"></a>        <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb5-341"><a href="#cb5-341" aria-hidden="true" tabindex="-1"></a>        <span class="dt">scale</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb5-342"><a href="#cb5-342" aria-hidden="true" tabindex="-1"></a>        <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb5-343"><a href="#cb5-343" aria-hidden="true" tabindex="-1"></a>      })<span class="op">.</span><span class="fu">get</span>(<span class="st">'avg_rad'</span>)<span class="op">;</span></span>
<span id="cb5-344"><a href="#cb5-344" aria-hidden="true" tabindex="-1"></a>      meanDN <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(meanDN<span class="op">,</span> meanDN<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-345"><a href="#cb5-345" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> logDN <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(meanDN)<span class="op">.</span><span class="fu">log</span>()<span class="op">;</span></span>
<span id="cb5-346"><a href="#cb5-346" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> logNCitj <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-347"><a href="#cb5-347" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'eastern'</span>)<span class="op">,</span></span>
<span id="cb5-348"><a href="#cb5-348" aria-hidden="true" tabindex="-1"></a>        logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">1.0484</span>)<span class="op">.</span><span class="fu">add</span>(ee<span class="op">.</span><span class="fu">Number</span>(Vit)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">6.1871</span>))<span class="op">,</span></span>
<span id="cb5-349"><a href="#cb5-349" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-350"><a href="#cb5-350" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'central'</span>)<span class="op">,</span></span>
<span id="cb5-351"><a href="#cb5-351" aria-hidden="true" tabindex="-1"></a>          logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.8773</span>)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">4.2414</span>)<span class="op">,</span></span>
<span id="cb5-352"><a href="#cb5-352" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-353"><a href="#cb5-353" aria-hidden="true" tabindex="-1"></a>            ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'western'</span>)<span class="op">,</span></span>
<span id="cb5-354"><a href="#cb5-354" aria-hidden="true" tabindex="-1"></a>            logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.3645</span>)<span class="op">.</span><span class="fu">add</span>(ee<span class="op">.</span><span class="fu">Number</span>(Vit)<span class="op">.</span><span class="fu">add</span>(<span class="fl">2.2189</span>))<span class="op">,</span></span>
<span id="cb5-355"><a href="#cb5-355" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span></span>
<span id="cb5-356"><a href="#cb5-356" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb5-357"><a href="#cb5-357" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-358"><a href="#cb5-358" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb5-359"><a href="#cb5-359" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> NCitj <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(logNCitj)<span class="op">.</span><span class="fu">exp</span>()<span class="op">;</span></span>
<span id="cb5-360"><a href="#cb5-360" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> emission <span class="op">=</span> NCitj<span class="op">.</span><span class="fu">multiply</span>(cityArea)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">250000</span>)<span class="op">;</span></span>
<span id="cb5-361"><a href="#cb5-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-362"><a href="#cb5-362" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> rain_temp_par <span class="op">=</span> fldas<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb5-363"><a href="#cb5-363" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rain * 60 * 60 * 24 * 30'</span><span class="op">,</span> {<span class="st">'rain'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Rainf_f_tavg'</span>)}</span>
<span id="cb5-364"><a href="#cb5-364" aria-hidden="true" tabindex="-1"></a>      )<span class="op">.</span><span class="fu">rename</span>(<span class="st">'rain'</span>)</span>
<span id="cb5-365"><a href="#cb5-365" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">addBands</span>(fldas<span class="op">.</span><span class="fu">expression</span>(<span class="st">'temp - 273.15'</span><span class="op">,</span> {<span class="st">'temp'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Tair_f_tavg'</span>)})<span class="op">.</span><span class="fu">rename</span>(<span class="st">'temp'</span>))</span>
<span id="cb5-366"><a href="#cb5-366" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">addBands</span>(fldas<span class="op">.</span><span class="fu">expression</span>(<span class="st">'rad * 60 * 60 * 24 * 30 / 1e6 * 0.5'</span><span class="op">,</span> {<span class="st">'rad'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Swnet_tavg'</span>)})<span class="op">.</span><span class="fu">rename</span>(<span class="st">'par'</span>))<span class="op">;</span></span>
<span id="cb5-367"><a href="#cb5-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-368"><a href="#cb5-368" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> ndvi_pro <span class="op">=</span> ndvi<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">;</span></span>
<span id="cb5-369"><a href="#cb5-369" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> SR <span class="op">=</span> ndvi_pro<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(ndvi_pro))<span class="op">.</span><span class="fu">rename</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-370"><a href="#cb5-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-371"><a href="#cb5-371" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> SR_min <span class="op">=</span> SR<span class="op">.</span><span class="fu">reduceRegion</span>({<span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span>})<span class="op">.</span><span class="fu">get</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-372"><a href="#cb5-372" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> SR_max <span class="op">=</span> SR<span class="op">.</span><span class="fu">reduceRegion</span>({<span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span>})<span class="op">.</span><span class="fu">get</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-373"><a href="#cb5-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-374"><a href="#cb5-374" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> FPAR <span class="op">=</span> SR<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_min))<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_max)<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_min)))<span class="op">.</span><span class="fu">clamp</span>(<span class="dv">0</span><span class="op">,</span> <span class="fl">0.95</span>)<span class="op">;</span></span>
<span id="cb5-375"><a href="#cb5-375" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> FPAR_filled <span class="op">=</span> FPAR<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(FPAR)<span class="op">;</span></span>
<span id="cb5-376"><a href="#cb5-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-377"><a href="#cb5-377" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> WE <span class="op">=</span> evap<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb5-378"><a href="#cb5-378" aria-hidden="true" tabindex="-1"></a>        <span class="st">'0.5 * ((0.5 + E) / Ep)'</span><span class="op">,</span> {</span>
<span id="cb5-379"><a href="#cb5-379" aria-hidden="true" tabindex="-1"></a>          <span class="st">'E'</span><span class="op">:</span> evap<span class="op">.</span><span class="fu">select</span>(<span class="st">'ET'</span>)<span class="op">,</span></span>
<span id="cb5-380"><a href="#cb5-380" aria-hidden="true" tabindex="-1"></a>          <span class="st">'Ep'</span><span class="op">:</span> evap<span class="op">.</span><span class="fu">select</span>(<span class="st">'PET'</span>)</span>
<span id="cb5-381"><a href="#cb5-381" aria-hidden="true" tabindex="-1"></a>        })<span class="op">.</span><span class="fu">rename</span>(<span class="st">'WE'</span>)<span class="op">;</span></span>
<span id="cb5-382"><a href="#cb5-382" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> WE_filled <span class="op">=</span> WE<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(WE)<span class="op">;</span></span>
<span id="cb5-383"><a href="#cb5-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-384"><a href="#cb5-384" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> T_opt <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'temp'</span>)<span class="op">;</span></span>
<span id="cb5-385"><a href="#cb5-385" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> Te1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">0.8</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.027</span>))<span class="op">.</span><span class="fu">subtract</span>(T_opt<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00005</span>))<span class="op">;</span></span>
<span id="cb5-386"><a href="#cb5-386" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> Te2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">1.184</span>)</span>
<span id="cb5-387"><a href="#cb5-387" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">subtract</span>(T_opt)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.2</span>)<span class="op">.</span><span class="fu">exp</span>()))</span>
<span id="cb5-388"><a href="#cb5-388" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">add</span>(T_opt)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.3</span>)<span class="op">.</span><span class="fu">exp</span>())))<span class="op">;</span></span>
<span id="cb5-389"><a href="#cb5-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-390"><a href="#cb5-390" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> epsilon <span class="op">=</span> Te1<span class="op">.</span><span class="fu">multiply</span>(Te2)<span class="op">.</span><span class="fu">multiply</span>(WE_filled)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.95</span>)<span class="op">;</span></span>
<span id="cb5-391"><a href="#cb5-391" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> epsilon_filled <span class="op">=</span> epsilon<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(epsilon)<span class="op">;</span></span>
<span id="cb5-392"><a href="#cb5-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-393"><a href="#cb5-393" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> common_mask <span class="op">=</span> FPAR_filled<span class="op">.</span><span class="fu">mask</span>()</span>
<span id="cb5-394"><a href="#cb5-394" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">and</span>(epsilon_filled<span class="op">.</span><span class="fu">mask</span>())</span>
<span id="cb5-395"><a href="#cb5-395" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">and</span>(WE_filled<span class="op">.</span><span class="fu">mask</span>())</span>
<span id="cb5-396"><a href="#cb5-396" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">and</span>(rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'par'</span>)<span class="op">.</span><span class="fu">mask</span>())<span class="op">;</span></span>
<span id="cb5-397"><a href="#cb5-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-398"><a href="#cb5-398" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> par_masked <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'par'</span>)<span class="op">.</span><span class="fu">updateMask</span>(common_mask)<span class="op">;</span></span>
<span id="cb5-399"><a href="#cb5-399" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> NPP <span class="op">=</span> par_masked<span class="op">.</span><span class="fu">multiply</span>(FPAR_filled)<span class="op">.</span><span class="fu">multiply</span>(epsilon_filled)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'NPP'</span>)<span class="op">;</span></span>
<span id="cb5-400"><a href="#cb5-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-401"><a href="#cb5-401" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> meanNPP <span class="op">=</span> NPP<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb5-402"><a href="#cb5-402" aria-hidden="true" tabindex="-1"></a>        <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb5-403"><a href="#cb5-403" aria-hidden="true" tabindex="-1"></a>        <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb5-404"><a href="#cb5-404" aria-hidden="true" tabindex="-1"></a>        <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb5-405"><a href="#cb5-405" aria-hidden="true" tabindex="-1"></a>        <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb5-406"><a href="#cb5-406" aria-hidden="true" tabindex="-1"></a>      })<span class="op">.</span><span class="fu">get</span>(<span class="st">'NPP'</span>)<span class="op">;</span></span>
<span id="cb5-407"><a href="#cb5-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-408"><a href="#cb5-408" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> totalCarbon_g <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(meanNPP)<span class="op">.</span><span class="fu">multiply</span>(cityArea)<span class="op">;</span></span>
<span id="cb5-409"><a href="#cb5-409" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> totalCO2_g <span class="op">=</span> totalCarbon_g<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">44</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb5-410"><a href="#cb5-410" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> totalCO2_kt <span class="op">=</span> totalCO2_g<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e8</span>)<span class="op">;</span></span>
<span id="cb5-411"><a href="#cb5-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-412"><a href="#cb5-412" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> netEmission <span class="op">=</span> emission<span class="op">.</span><span class="fu">subtract</span>(totalCO2_kt)<span class="op">;</span></span>
<span id="cb5-413"><a href="#cb5-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-414"><a href="#cb5-414" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {</span>
<span id="cb5-415"><a href="#cb5-415" aria-hidden="true" tabindex="-1"></a>        <span class="st">'month'</span><span class="op">:</span> m<span class="op">,</span></span>
<span id="cb5-416"><a href="#cb5-416" aria-hidden="true" tabindex="-1"></a>        <span class="st">'emission'</span><span class="op">:</span> emission<span class="op">,</span></span>
<span id="cb5-417"><a href="#cb5-417" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sequestration'</span><span class="op">:</span> totalCO2_kt<span class="op">,</span></span>
<span id="cb5-418"><a href="#cb5-418" aria-hidden="true" tabindex="-1"></a>        <span class="st">'netEmission'</span><span class="op">:</span> netEmission</span>
<span id="cb5-419"><a href="#cb5-419" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb5-420"><a href="#cb5-420" aria-hidden="true" tabindex="-1"></a>    })()<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb5-421"><a href="#cb5-421" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb5-422"><a href="#cb5-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-423"><a href="#cb5-423" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> fc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(monthly)</span>
<span id="cb5-424"><a href="#cb5-424" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">notNull</span>([<span class="st">'emission'</span>]))</span>
<span id="cb5-425"><a href="#cb5-425" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">sort</span>(<span class="st">'month'</span>)<span class="op">;</span></span>
<span id="cb5-426"><a href="#cb5-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-427"><a href="#cb5-427" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byFeature</span>(fc<span class="op">,</span> <span class="st">'month'</span><span class="op">,</span> [<span class="st">'emission'</span><span class="op">,</span> <span class="st">'sequestration'</span><span class="op">,</span> <span class="st">'netEmission'</span>])</span>
<span id="cb5-428"><a href="#cb5-428" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">setChartType</span>(<span class="st">'LineChart'</span>)</span>
<span id="cb5-429"><a href="#cb5-429" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb5-430"><a href="#cb5-430" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">'Monthly Carbon Emission / Sequestration / Net Emission</span><span class="sc">\n</span><span class="st">'</span> <span class="op">+</span> provinceName <span class="op">+</span> <span class="st">'（'</span> <span class="op">+</span> year <span class="op">+</span> <span class="st">'）'</span><span class="op">,</span></span>
<span id="cb5-431"><a href="#cb5-431" aria-hidden="true" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">'Month'</span>}<span class="op">,</span></span>
<span id="cb5-432"><a href="#cb5-432" aria-hidden="true" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">'Amount (10ktons CO₂)'</span>}<span class="op">,</span></span>
<span id="cb5-433"><a href="#cb5-433" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb5-434"><a href="#cb5-434" aria-hidden="true" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb5-435"><a href="#cb5-435" aria-hidden="true" tabindex="-1"></a>      <span class="dt">height</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb5-436"><a href="#cb5-436" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">'bottom'</span>}</span>
<span id="cb5-437"><a href="#cb5-437" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb5-438"><a href="#cb5-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-439"><a href="#cb5-439" aria-hidden="true" tabindex="-1"></a>  chartPanel<span class="op">.</span><span class="fu">add</span>(chart)<span class="op">;</span></span>
<span id="cb5-440"><a href="#cb5-440" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-441"><a href="#cb5-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-442"><a href="#cb5-442" aria-hidden="true" tabindex="-1"></a><span class="co">// figure4: Total carbon emisssions,sequestration,netemisssions amount in cities (10ktons CO₂)</span></span>
<span id="cb5-443"><a href="#cb5-443" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plotSinglecityCarbonChart</span>(cityName<span class="op">,</span> geometry<span class="op">,</span> year) {</span>
<span id="cb5-444"><a href="#cb5-444" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>(<span class="kw">function</span>(resolve<span class="op">,</span> reject) {</span>
<span id="cb5-445"><a href="#cb5-445" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb5-446"><a href="#cb5-446" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> cityArea <span class="op">=</span> geometry<span class="op">.</span><span class="fu">area</span>()<span class="op">;</span></span>
<span id="cb5-447"><a href="#cb5-447" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> cityFeature <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filterBounds</span>(geometry)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-448"><a href="#cb5-448" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> region <span class="op">=</span> cityFeature<span class="op">.</span><span class="fu">get</span>(<span class="st">'region'</span>)<span class="op">;</span></span>
<span id="cb5-449"><a href="#cb5-449" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> Vit <span class="op">=</span> cityFeature<span class="op">.</span><span class="fu">get</span>(<span class="st">'Vit'</span>)<span class="op">;</span></span>
<span id="cb5-450"><a href="#cb5-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-451"><a href="#cb5-451" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(m) {</span>
<span id="cb5-452"><a href="#cb5-452" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> start <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> m<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb5-453"><a href="#cb5-453" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> end <span class="op">=</span> start<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">'month'</span>)<span class="op">;</span></span>
<span id="cb5-454"><a href="#cb5-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-455"><a href="#cb5-455" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> nightLight <span class="op">=</span> dataset<span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb5-456"><a href="#cb5-456" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> fldas <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'NASA/FLDAS/NOAH01/C/GL/M/V001'</span>)<span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-457"><a href="#cb5-457" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> ndvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'MODIS/061/MOD13A2'</span>)<span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">select</span>(<span class="st">'NDVI'</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-458"><a href="#cb5-458" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> evapCollection <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(year <span class="op">&lt;=</span> <span class="dv">2020</span> <span class="op">?</span> <span class="st">'MODIS/061/MOD16A2GF'</span> <span class="op">:</span> <span class="st">'MODIS/061/MOD16A2'</span>)<span class="op">;</span></span>
<span id="cb5-459"><a href="#cb5-459" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> evap <span class="op">=</span> evapCollection<span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-460"><a href="#cb5-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-461"><a href="#cb5-461" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(nightLight <span class="op">&amp;&amp;</span> fldas <span class="op">&amp;&amp;</span> ndvi <span class="op">&amp;&amp;</span> evap<span class="op">,</span> (<span class="kw">function</span>() {</span>
<span id="cb5-462"><a href="#cb5-462" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> meanDN <span class="op">=</span> nightLight<span class="op">.</span><span class="fu">select</span>(<span class="st">'avg_rad'</span>)<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb5-463"><a href="#cb5-463" aria-hidden="true" tabindex="-1"></a>          <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb5-464"><a href="#cb5-464" aria-hidden="true" tabindex="-1"></a>          <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb5-465"><a href="#cb5-465" aria-hidden="true" tabindex="-1"></a>          <span class="dt">scale</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb5-466"><a href="#cb5-466" aria-hidden="true" tabindex="-1"></a>          <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb5-467"><a href="#cb5-467" aria-hidden="true" tabindex="-1"></a>        })<span class="op">.</span><span class="fu">get</span>(<span class="st">'avg_rad'</span>)<span class="op">;</span></span>
<span id="cb5-468"><a href="#cb5-468" aria-hidden="true" tabindex="-1"></a>        meanDN <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(meanDN<span class="op">,</span> meanDN<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-469"><a href="#cb5-469" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> logDN <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(meanDN)<span class="op">.</span><span class="fu">log</span>()<span class="op">;</span></span>
<span id="cb5-470"><a href="#cb5-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-471"><a href="#cb5-471" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> logNCitj <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-472"><a href="#cb5-472" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'eastern'</span>)<span class="op">,</span></span>
<span id="cb5-473"><a href="#cb5-473" aria-hidden="true" tabindex="-1"></a>          logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">1.0484</span>)<span class="op">.</span><span class="fu">add</span>(ee<span class="op">.</span><span class="fu">Number</span>(Vit)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">6.1871</span>))<span class="op">,</span></span>
<span id="cb5-474"><a href="#cb5-474" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-475"><a href="#cb5-475" aria-hidden="true" tabindex="-1"></a>            ee<span class="op">.</span><span class="fu">String</span>(region)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'central'</span>)<span class="op">,</span></span>
<span id="cb5-476"><a href="#cb5-476" aria-hidden="true" tabindex="-1"></a>            logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.8773</span>)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">4.2414</span>)<span class="op">,</span></span>
<span id="cb5-477"><a href="#cb5-477" aria-hidden="true" tabindex="-1"></a>            logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.3645</span>)<span class="op">.</span><span class="fu">add</span>(ee<span class="op">.</span><span class="fu">Number</span>(Vit)<span class="op">.</span><span class="fu">add</span>(<span class="fl">2.2189</span>))</span>
<span id="cb5-478"><a href="#cb5-478" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb5-479"><a href="#cb5-479" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb5-480"><a href="#cb5-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-481"><a href="#cb5-481" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> NCitj <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(logNCitj)<span class="op">.</span><span class="fu">exp</span>()<span class="op">;</span></span>
<span id="cb5-482"><a href="#cb5-482" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> emission <span class="op">=</span> NCitj<span class="op">.</span><span class="fu">multiply</span>(cityArea)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">250000</span>)<span class="op">;</span></span>
<span id="cb5-483"><a href="#cb5-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-484"><a href="#cb5-484" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> rain_temp_par <span class="op">=</span> fldas<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb5-485"><a href="#cb5-485" aria-hidden="true" tabindex="-1"></a>          <span class="st">'rain * 60 * 60 * 24 * 30'</span><span class="op">,</span> {<span class="st">'rain'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Rainf_f_tavg'</span>)}</span>
<span id="cb5-486"><a href="#cb5-486" aria-hidden="true" tabindex="-1"></a>        )<span class="op">.</span><span class="fu">rename</span>(<span class="st">'rain'</span>)</span>
<span id="cb5-487"><a href="#cb5-487" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">addBands</span>(fldas<span class="op">.</span><span class="fu">expression</span>(<span class="st">'temp - 273.15'</span><span class="op">,</span> {<span class="st">'temp'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Tair_f_tavg'</span>)})<span class="op">.</span><span class="fu">rename</span>(<span class="st">'temp'</span>))</span>
<span id="cb5-488"><a href="#cb5-488" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">addBands</span>(fldas<span class="op">.</span><span class="fu">expression</span>(<span class="st">'rad * 60 * 60 * 24 * 30 / 1e6 * 0.5'</span><span class="op">,</span> {<span class="st">'rad'</span><span class="op">:</span> fldas<span class="op">.</span><span class="fu">select</span>(<span class="st">'Swnet_tavg'</span>)})<span class="op">.</span><span class="fu">rename</span>(<span class="st">'par'</span>))<span class="op">;</span></span>
<span id="cb5-489"><a href="#cb5-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-490"><a href="#cb5-490" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> ndvi_pro <span class="op">=</span> ndvi<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">;</span></span>
<span id="cb5-491"><a href="#cb5-491" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> SR <span class="op">=</span> ndvi_pro<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(ndvi_pro))<span class="op">.</span><span class="fu">rename</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-492"><a href="#cb5-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-493"><a href="#cb5-493" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> SR_min <span class="op">=</span> SR<span class="op">.</span><span class="fu">reduceRegion</span>({<span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span>})<span class="op">.</span><span class="fu">get</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-494"><a href="#cb5-494" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> SR_max <span class="op">=</span> SR<span class="op">.</span><span class="fu">reduceRegion</span>({<span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span>})<span class="op">.</span><span class="fu">get</span>(<span class="st">'SR'</span>)<span class="op">;</span></span>
<span id="cb5-495"><a href="#cb5-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-496"><a href="#cb5-496" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> FPAR <span class="op">=</span> SR<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_min))<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_max)<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(SR_min)))<span class="op">.</span><span class="fu">clamp</span>(<span class="dv">0</span><span class="op">,</span> <span class="fl">0.95</span>)<span class="op">;</span></span>
<span id="cb5-497"><a href="#cb5-497" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> FPAR_filled <span class="op">=</span> FPAR<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(FPAR)<span class="op">;</span></span>
<span id="cb5-498"><a href="#cb5-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-499"><a href="#cb5-499" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> WE <span class="op">=</span> evap<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb5-500"><a href="#cb5-500" aria-hidden="true" tabindex="-1"></a>          <span class="st">'0.5 * ((0.5 + E) / Ep)'</span><span class="op">,</span> {</span>
<span id="cb5-501"><a href="#cb5-501" aria-hidden="true" tabindex="-1"></a>            <span class="st">'E'</span><span class="op">:</span> evap<span class="op">.</span><span class="fu">select</span>(<span class="st">'ET'</span>)<span class="op">,</span></span>
<span id="cb5-502"><a href="#cb5-502" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Ep'</span><span class="op">:</span> evap<span class="op">.</span><span class="fu">select</span>(<span class="st">'PET'</span>)</span>
<span id="cb5-503"><a href="#cb5-503" aria-hidden="true" tabindex="-1"></a>          })<span class="op">.</span><span class="fu">rename</span>(<span class="st">'WE'</span>)<span class="op">;</span></span>
<span id="cb5-504"><a href="#cb5-504" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> WE_filled <span class="op">=</span> WE<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(WE)<span class="op">;</span></span>
<span id="cb5-505"><a href="#cb5-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-506"><a href="#cb5-506" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> T_opt <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'temp'</span>)<span class="op">;</span></span>
<span id="cb5-507"><a href="#cb5-507" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> Te1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">0.8</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.027</span>))<span class="op">.</span><span class="fu">subtract</span>(T_opt<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00005</span>))<span class="op">;</span></span>
<span id="cb5-508"><a href="#cb5-508" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> Te2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">1.184</span>)</span>
<span id="cb5-509"><a href="#cb5-509" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">subtract</span>(T_opt)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.2</span>)<span class="op">.</span><span class="fu">exp</span>()))</span>
<span id="cb5-510"><a href="#cb5-510" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(T_opt<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">add</span>(T_opt)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.3</span>)<span class="op">.</span><span class="fu">exp</span>())))<span class="op">;</span></span>
<span id="cb5-511"><a href="#cb5-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-512"><a href="#cb5-512" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> epsilon <span class="op">=</span> Te1<span class="op">.</span><span class="fu">multiply</span>(Te2)<span class="op">.</span><span class="fu">multiply</span>(WE_filled)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.95</span>)<span class="op">;</span></span>
<span id="cb5-513"><a href="#cb5-513" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> epsilon_filled <span class="op">=</span> epsilon<span class="op">.</span><span class="fu">unmask</span>()<span class="op">.</span><span class="fu">focal_mean</span>({<span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'pixels'</span>})<span class="op">.</span><span class="fu">blend</span>(epsilon)<span class="op">;</span></span>
<span id="cb5-514"><a href="#cb5-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-515"><a href="#cb5-515" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> common_mask <span class="op">=</span> FPAR_filled<span class="op">.</span><span class="fu">mask</span>()<span class="op">.</span><span class="fu">and</span>(epsilon_filled<span class="op">.</span><span class="fu">mask</span>())<span class="op">.</span><span class="fu">and</span>(WE_filled<span class="op">.</span><span class="fu">mask</span>())<span class="op">.</span><span class="fu">and</span>(rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'par'</span>)<span class="op">.</span><span class="fu">mask</span>())<span class="op">;</span></span>
<span id="cb5-516"><a href="#cb5-516" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> par_masked <span class="op">=</span> rain_temp_par<span class="op">.</span><span class="fu">select</span>(<span class="st">'par'</span>)<span class="op">.</span><span class="fu">updateMask</span>(common_mask)<span class="op">;</span></span>
<span id="cb5-517"><a href="#cb5-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-518"><a href="#cb5-518" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> NPP <span class="op">=</span> par_masked<span class="op">.</span><span class="fu">multiply</span>(FPAR_filled)<span class="op">.</span><span class="fu">multiply</span>(epsilon_filled)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'NPP'</span>)<span class="op">;</span></span>
<span id="cb5-519"><a href="#cb5-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-520"><a href="#cb5-520" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> meanNPP <span class="op">=</span> NPP<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb5-521"><a href="#cb5-521" aria-hidden="true" tabindex="-1"></a>          <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb5-522"><a href="#cb5-522" aria-hidden="true" tabindex="-1"></a>          <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb5-523"><a href="#cb5-523" aria-hidden="true" tabindex="-1"></a>          <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb5-524"><a href="#cb5-524" aria-hidden="true" tabindex="-1"></a>          <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb5-525"><a href="#cb5-525" aria-hidden="true" tabindex="-1"></a>        })<span class="op">.</span><span class="fu">get</span>(<span class="st">'NPP'</span>)<span class="op">;</span></span>
<span id="cb5-526"><a href="#cb5-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-527"><a href="#cb5-527" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> totalCarbon_g <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(meanNPP)<span class="op">.</span><span class="fu">multiply</span>(cityArea)<span class="op">;</span></span>
<span id="cb5-528"><a href="#cb5-528" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> totalCO2_g <span class="op">=</span> totalCarbon_g<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">44</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb5-529"><a href="#cb5-529" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> totalCO2_kt <span class="op">=</span> totalCO2_g<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e8</span>)<span class="op">;</span></span>
<span id="cb5-530"><a href="#cb5-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-531"><a href="#cb5-531" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> netEmission <span class="op">=</span> emission<span class="op">.</span><span class="fu">subtract</span>(totalCO2_kt)<span class="op">;</span></span>
<span id="cb5-532"><a href="#cb5-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-533"><a href="#cb5-533" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>([</span>
<span id="cb5-534"><a href="#cb5-534" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">'month'</span><span class="op">:</span> m<span class="op">,</span> <span class="st">'value'</span><span class="op">:</span> totalCO2_kt<span class="op">,</span> <span class="st">'type'</span><span class="op">:</span> <span class="st">'Sequestration'</span>})<span class="op">,</span></span>
<span id="cb5-535"><a href="#cb5-535" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">'month'</span><span class="op">:</span> m<span class="op">,</span> <span class="st">'value'</span><span class="op">:</span> emission<span class="op">,</span> <span class="st">'type'</span><span class="op">:</span> <span class="st">'Emission'</span>})<span class="op">,</span></span>
<span id="cb5-536"><a href="#cb5-536" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">'month'</span><span class="op">:</span> m<span class="op">,</span> <span class="st">'value'</span><span class="op">:</span> netEmission<span class="op">,</span> <span class="st">'type'</span><span class="op">:</span> <span class="st">'NetEmission'</span>})</span>
<span id="cb5-537"><a href="#cb5-537" aria-hidden="true" tabindex="-1"></a>        ])<span class="op">;</span></span>
<span id="cb5-538"><a href="#cb5-538" aria-hidden="true" tabindex="-1"></a>      })()<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb5-539"><a href="#cb5-539" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb5-540"><a href="#cb5-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-541"><a href="#cb5-541" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> fc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(monthly)<span class="op">.</span><span class="fu">flatten</span>()<span class="op">;</span></span>
<span id="cb5-542"><a href="#cb5-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-543"><a href="#cb5-543" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">groups</span>({</span>
<span id="cb5-544"><a href="#cb5-544" aria-hidden="true" tabindex="-1"></a>      <span class="dt">features</span><span class="op">:</span> fc<span class="op">,</span></span>
<span id="cb5-545"><a href="#cb5-545" aria-hidden="true" tabindex="-1"></a>      <span class="dt">xProperty</span><span class="op">:</span> <span class="st">'month'</span><span class="op">,</span></span>
<span id="cb5-546"><a href="#cb5-546" aria-hidden="true" tabindex="-1"></a>      <span class="dt">yProperty</span><span class="op">:</span> <span class="st">'value'</span><span class="op">,</span></span>
<span id="cb5-547"><a href="#cb5-547" aria-hidden="true" tabindex="-1"></a>      <span class="dt">seriesProperty</span><span class="op">:</span> <span class="st">'type'</span></span>
<span id="cb5-548"><a href="#cb5-548" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb5-549"><a href="#cb5-549" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">setChartType</span>(<span class="st">'LineChart'</span>)</span>
<span id="cb5-550"><a href="#cb5-550" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb5-551"><a href="#cb5-551" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">'Monthly Carbon Sequestration / Emissions / Net Emissions</span><span class="sc">\n</span><span class="st">'</span> <span class="op">+</span> cityName <span class="op">+</span> <span class="st">' ('</span> <span class="op">+</span> year <span class="op">+</span> <span class="st">')'</span><span class="op">,</span></span>
<span id="cb5-552"><a href="#cb5-552" aria-hidden="true" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">'Month'</span>}<span class="op">,</span></span>
<span id="cb5-553"><a href="#cb5-553" aria-hidden="true" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">'Amount (10ktons CO₂)'</span>}<span class="op">,</span></span>
<span id="cb5-554"><a href="#cb5-554" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb5-555"><a href="#cb5-555" aria-hidden="true" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb5-556"><a href="#cb5-556" aria-hidden="true" tabindex="-1"></a>      <span class="dt">height</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb5-557"><a href="#cb5-557" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">'bottom'</span>}</span>
<span id="cb5-558"><a href="#cb5-558" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb5-559"><a href="#cb5-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-560"><a href="#cb5-560" aria-hidden="true" tabindex="-1"></a>    chartPanel<span class="op">.</span><span class="fu">add</span>(chart)<span class="op">;</span></span>
<span id="cb5-561"><a href="#cb5-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-562"><a href="#cb5-562" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> annualNetEmission <span class="op">=</span> fc<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'type'</span><span class="op">,</span> <span class="st">'NetEmission'</span>))</span>
<span id="cb5-563"><a href="#cb5-563" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">aggregate_sum</span>(<span class="st">'value'</span>)<span class="op">;</span></span>
<span id="cb5-564"><a href="#cb5-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-565"><a href="#cb5-565" aria-hidden="true" tabindex="-1"></a>    annualNetEmission<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(netEmissionValue) {</span>
<span id="cb5-566"><a href="#cb5-566" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (netEmissionValue <span class="op">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb5-567"><a href="#cb5-567" aria-hidden="true" tabindex="-1"></a>        chartPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'This city</span><span class="sc">\'</span><span class="st">s annual net CO₂ emissions are less than zero, indicating a carbon sink city.'</span>))<span class="op">;</span></span>
<span id="cb5-568"><a href="#cb5-568" aria-hidden="true" tabindex="-1"></a>        <span class="fu">resolve</span>()<span class="op">;</span></span>
<span id="cb5-569"><a href="#cb5-569" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb5-570"><a href="#cb5-570" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> cityFeature <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'NAME_2'</span><span class="op">,</span> cityName))<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb5-571"><a href="#cb5-571" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> urbanAgg <span class="op">=</span> cityFeature<span class="op">.</span><span class="fu">get</span>(<span class="st">'UrbanAgg'</span>)<span class="op">;</span></span>
<span id="cb5-572"><a href="#cb5-572" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> urbanAggCities <span class="op">=</span> matchedCities<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'UrbanAgg'</span><span class="op">,</span> urbanAgg))<span class="op">;</span></span>
<span id="cb5-573"><a href="#cb5-573" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> urbanAggGeom <span class="op">=</span> urbanAggCities<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb5-574"><a href="#cb5-574" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> sampleRegion <span class="op">=</span> cityFeature<span class="op">.</span><span class="fu">get</span>(<span class="st">'region'</span>)<span class="op">;</span></span>
<span id="cb5-575"><a href="#cb5-575" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> sampleVit <span class="op">=</span> cityFeature<span class="op">.</span><span class="fu">get</span>(<span class="st">'Vit'</span>)<span class="op">;</span></span>
<span id="cb5-576"><a href="#cb5-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-577"><a href="#cb5-577" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> urbanAggMonthly <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(m) {</span>
<span id="cb5-578"><a href="#cb5-578" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> start <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> m<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb5-579"><a href="#cb5-579" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> end <span class="op">=</span> start<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">'month'</span>)<span class="op">;</span></span>
<span id="cb5-580"><a href="#cb5-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-581"><a href="#cb5-581" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> nightLight <span class="op">=</span> dataset<span class="op">.</span><span class="fu">filterDate</span>(start<span class="op">,</span> end)<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">clip</span>(urbanAggGeom)<span class="op">;</span></span>
<span id="cb5-582"><a href="#cb5-582" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> meanDN <span class="op">=</span> nightLight<span class="op">.</span><span class="fu">select</span>(<span class="st">'avg_rad'</span>)<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb5-583"><a href="#cb5-583" aria-hidden="true" tabindex="-1"></a>            <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb5-584"><a href="#cb5-584" aria-hidden="true" tabindex="-1"></a>            <span class="dt">geometry</span><span class="op">:</span> urbanAggGeom<span class="op">,</span></span>
<span id="cb5-585"><a href="#cb5-585" aria-hidden="true" tabindex="-1"></a>            <span class="dt">scale</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb5-586"><a href="#cb5-586" aria-hidden="true" tabindex="-1"></a>            <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb5-587"><a href="#cb5-587" aria-hidden="true" tabindex="-1"></a>          })<span class="op">.</span><span class="fu">get</span>(<span class="st">'avg_rad'</span>)<span class="op">;</span></span>
<span id="cb5-588"><a href="#cb5-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-589"><a href="#cb5-589" aria-hidden="true" tabindex="-1"></a>          meanDN <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(meanDN<span class="op">,</span> meanDN<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-590"><a href="#cb5-590" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> logDN <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(meanDN)<span class="op">.</span><span class="fu">log</span>()<span class="op">;</span></span>
<span id="cb5-591"><a href="#cb5-591" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> logNCitj <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-592"><a href="#cb5-592" aria-hidden="true" tabindex="-1"></a>            ee<span class="op">.</span><span class="fu">String</span>(sampleRegion)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'eastern'</span>)<span class="op">,</span></span>
<span id="cb5-593"><a href="#cb5-593" aria-hidden="true" tabindex="-1"></a>            logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">1.0484</span>)<span class="op">.</span><span class="fu">add</span>(ee<span class="op">.</span><span class="fu">Number</span>(sampleVit)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">6.1871</span>))<span class="op">,</span></span>
<span id="cb5-594"><a href="#cb5-594" aria-hidden="true" tabindex="-1"></a>            ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-595"><a href="#cb5-595" aria-hidden="true" tabindex="-1"></a>              ee<span class="op">.</span><span class="fu">String</span>(sampleRegion)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'central'</span>)<span class="op">,</span></span>
<span id="cb5-596"><a href="#cb5-596" aria-hidden="true" tabindex="-1"></a>              logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.8773</span>)<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">4.2414</span>)<span class="op">,</span></span>
<span id="cb5-597"><a href="#cb5-597" aria-hidden="true" tabindex="-1"></a>              logDN<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.3645</span>)<span class="op">.</span><span class="fu">add</span>(ee<span class="op">.</span><span class="fu">Number</span>(sampleVit)<span class="op">.</span><span class="fu">add</span>(<span class="fl">2.2189</span>))</span>
<span id="cb5-598"><a href="#cb5-598" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-599"><a href="#cb5-599" aria-hidden="true" tabindex="-1"></a>          )<span class="op">;</span></span>
<span id="cb5-600"><a href="#cb5-600" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> NCitj <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(logNCitj)<span class="op">.</span><span class="fu">exp</span>()<span class="op">;</span></span>
<span id="cb5-601"><a href="#cb5-601" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> aggArea <span class="op">=</span> urbanAggGeom<span class="op">.</span><span class="fu">area</span>()<span class="op">;</span></span>
<span id="cb5-602"><a href="#cb5-602" aria-hidden="true" tabindex="-1"></a>          <span class="kw">var</span> totalEmission <span class="op">=</span> NCitj<span class="op">.</span><span class="fu">multiply</span>(aggArea)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">250000</span>)<span class="op">;</span></span>
<span id="cb5-603"><a href="#cb5-603" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> totalEmission<span class="op">;</span></span>
<span id="cb5-604"><a href="#cb5-604" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb5-605"><a href="#cb5-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-606"><a href="#cb5-606" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> annualUrbanAggNetEmission <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(urbanAggMonthly<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()))<span class="op">;</span></span>
<span id="cb5-607"><a href="#cb5-607" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> cityEmission <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(netEmissionValue)<span class="op">;</span></span>
<span id="cb5-608"><a href="#cb5-608" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> restEmission <span class="op">=</span> annualUrbanAggNetEmission<span class="op">.</span><span class="fu">subtract</span>(cityEmission)<span class="op">;</span></span>
<span id="cb5-609"><a href="#cb5-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-610"><a href="#cb5-610" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> pieData <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>([</span>
<span id="cb5-611"><a href="#cb5-611" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">'category'</span><span class="op">:</span> cityName<span class="op">,</span> <span class="st">'emission'</span><span class="op">:</span> cityEmission})<span class="op">,</span></span>
<span id="cb5-612"><a href="#cb5-612" aria-hidden="true" tabindex="-1"></a>          ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">'category'</span><span class="op">:</span> <span class="st">'Rest of '</span> <span class="op">+</span> urbanAgg<span class="op">.</span><span class="fu">getInfo</span>()<span class="op">,</span> <span class="st">'emission'</span><span class="op">:</span> restEmission})</span>
<span id="cb5-613"><a href="#cb5-613" aria-hidden="true" tabindex="-1"></a>        ])<span class="op">;</span></span>
<span id="cb5-614"><a href="#cb5-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-615"><a href="#cb5-615" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> pieChart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byFeature</span>(pieData<span class="op">,</span> <span class="st">'category'</span><span class="op">,</span> <span class="st">'emission'</span>)</span>
<span id="cb5-616"><a href="#cb5-616" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">setChartType</span>(<span class="st">'PieChart'</span>)</span>
<span id="cb5-617"><a href="#cb5-617" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb5-618"><a href="#cb5-618" aria-hidden="true" tabindex="-1"></a>            <span class="dt">title</span><span class="op">:</span> <span class="st">'Annual Net CO₂ Emissions Comparison (10ktons):</span><span class="sc">\n</span><span class="st">City vs Rest of Urban Agglomeration'</span><span class="op">,</span></span>
<span id="cb5-619"><a href="#cb5-619" aria-hidden="true" tabindex="-1"></a>            <span class="dt">sliceVisibilityThreshold</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb5-620"><a href="#cb5-620" aria-hidden="true" tabindex="-1"></a>            <span class="dt">legend</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">'right'</span>}<span class="op">,</span></span>
<span id="cb5-621"><a href="#cb5-621" aria-hidden="true" tabindex="-1"></a>            <span class="dt">pieSliceText</span><span class="op">:</span> <span class="st">'percentage'</span><span class="op">,</span></span>
<span id="cb5-622"><a href="#cb5-622" aria-hidden="true" tabindex="-1"></a>            <span class="dt">height</span><span class="op">:</span> <span class="dv">280</span></span>
<span id="cb5-623"><a href="#cb5-623" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb5-624"><a href="#cb5-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-625"><a href="#cb5-625" aria-hidden="true" tabindex="-1"></a>        chartPanel<span class="op">.</span><span class="fu">add</span>(pieChart)<span class="op">;</span></span>
<span id="cb5-626"><a href="#cb5-626" aria-hidden="true" tabindex="-1"></a>        <span class="fu">resolve</span>()<span class="op">;</span></span>
<span id="cb5-627"><a href="#cb5-627" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-628"><a href="#cb5-628" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb5-629"><a href="#cb5-629" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb5-630"><a href="#cb5-630" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="bibliography" class="level2">
<h2 class="anchored" data-anchor-id="bibliography">Bibliography</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Ahmad2022" class="csl-entry" role="listitem">
Ahmad, Adnan, Shahid Ahmad, Ghulam Nabi, Qi-Jing Liu, Nazirul Islam, and Xiaofeng Luan. 2022. <span>“Trends in Deforestation as a Response to Management Regimes and Policy Intervention in the Hindu Kush Himalaya of Pakistan.”</span> <em>Frontiers in Environmental Science</em> 10. <a href="https://doi.org/10.3389/fenvs.2022.810806">https://doi.org/10.3389/fenvs.2022.810806</a>.
</div>
<div id="ref-AlKafy2023" class="csl-entry" role="listitem">
Al Kafy, Abdulla -, Milan Saha, Md. Abdul Fattah, Muhammad Tauhidur Rahman, Bushra Monowar Duti, Zullyadini A. Rahaman, Arpita Bakshi, S. Kalaivani, Sk Nafiz Rahaman, and Golam Shabbir Sattar. 2023. <span>“Integrating Forest Cover Change and Carbon Storage Dynamics: Leveraging Google Earth Engine and InVEST Model to Inform Conservation in Hilly Regions.”</span> <em>Ecological Indicators</em> 152: 110374. https://doi.org/<a href="https://doi.org/10.1016/j.ecolind.2023.110374">https://doi.org/10.1016/j.ecolind.2023.110374</a>.
</div>
<div id="ref-Das2023" class="csl-entry" role="listitem">
Das, Manob, Ashis Mandal, Arijit Das, Miguel Inácio, and Paulo Pereira. 2023. <span>“Mapping and Assessment of Carbon Sequestration Potential and Its Drivers in the Eastern Himalayan Region (India).”</span> <em>Case Studies in Chemical and Environmental Engineering</em> 7: 100344. https://doi.org/<a href="https://doi.org/10.1016/j.cscee.2023.100344">https://doi.org/10.1016/j.cscee.2023.100344</a>.
</div>
<div id="ref-gadm2022" class="csl-entry" role="listitem">
<span>“GADM: Global Administrative Areas.”</span> 2022. <a href="https://gadm.org/index.html">https://gadm.org/index.html</a>.
</div>
<div id="ref-Legesse2024" class="csl-entry" role="listitem">
Legesse, F., S. Degefa, and T. Soromessa. 2024. <span>“Estimating Carbon Stock Using Vegetation Indices and Empirical Data in the Upper Awash River Basin.”</span> <em>Discover Environment</em> 2: 137. <a href="https://doi.org/10.1007/s44274-024-00165-8">https://doi.org/10.1007/s44274-024-00165-8</a>.
</div>
<div id="ref-Liu2018" class="csl-entry" role="listitem">
Liu, Xiaoping, Jinpei Ou, Shaojian Wang, Xia Li, Yuchao Yan, Limin Jiao, and Yaolin Liu. 2018. <span>“Estimating Spatiotemporal Variations of City-Level Energy-Related CO2 Emissions: An Improved Disaggregating Model Based on Vegetation Adjusted Nighttime Light Data.”</span> <em>Journal of Cleaner Production</em> 177: 101–14. https://doi.org/<a href="https://doi.org/10.1016/j.jclepro.2017.12.197">https://doi.org/10.1016/j.jclepro.2017.12.197</a>.
</div>
<div id="ref-Potter1993" class="csl-entry" role="listitem">
Potter, C. S., J. T. Randerson, C. B. Field, P. A. Matson, P. M. Vitousek, H. A. Mooney, and S. A. Klooster. 1993. <span>“Terrestrial Ecosystem Production: A Process Model Based on Global Satellite and Surface Data.”</span> <em>Global Biogeochemical Cycles</em> 7 (4): 811–41. <a href="https://doi.org/10.1029/93GB02725">https://doi.org/10.1029/93GB02725</a>.
</div>
<div id="ref-Wang2024" class="csl-entry" role="listitem">
Wang, Gengzhe, Qing Hu, Linghao He, Jialong Guo, Jin Huang, and Lijin Zhong. 2024. <span>“The Estimation of Building Carbon Emission Using Nighttime Light Images: A Comparative Study at Various Spatial Scales.”</span> <em>Sustainable Cities and Society</em> 101: 105066. https://doi.org/<a href="https://doi.org/10.1016/j.scs.2023.105066">https://doi.org/10.1016/j.scs.2023.105066</a>.
</div>
<div id="ref-Wu2022" class="csl-entry" role="listitem">
Wu, Xianhua, Zhiqing Tian, and Ji Guo. 2022. <span>“A Review of the Theoretical Research and Practical Progress of Carbon Neutrality.”</span> <em>Sustainable Operations and Computers</em> 3: 54–66. https://doi.org/<a href="https://doi.org/10.1016/j.susoc.2021.10.001">https://doi.org/10.1016/j.susoc.2021.10.001</a>.
</div>
<div id="ref-Yang2022" class="csl-entry" role="listitem">
Yang, Jie, Wei Li, Jie Chen, and Chao Sun. 2022. <span>“Refined Carbon Emission Measurement Based on NPP-VIIRS Nighttime Light Data: A Case Study of the Pearl River Delta Region, China.”</span> <em>Sensors (Basel)</em> 23 (1): 191. <a href="https://doi.org/10.3390/s23010191">https://doi.org/10.3390/s23010191</a>.
</div>
<div id="ref-yang2022" class="csl-entry" role="listitem">
Yang, Tianjiao, Jing Liu, Haibo Mi, Zhicheng Cao, Yiting Wang, Huichao Han, Jiahui Luan, and Zhaoxuan Wang. 2022. <span>“An Estimating Method for Carbon Emissions of China Based on Nighttime Lights Remote Sensing Satellite Images.”</span> <em>Sustainability</em> 14 (4): 2269. <a href="https://doi.org/10.3390/su14042269">https://doi.org/10.3390/su14042269</a>.
</div>
<div id="ref-Zuo2022" class="csl-entry" role="listitem">
Zuo, Chen, Wei Gong, Zhiyu Gao, Deyi Kong, Ruyi Wei, and Xin Ma. 2022. <span>“Correlation Analysis of CO2 Concentration Based on DMSP-OLS and NPP-VIIRS Integrated Data.”</span> <em>Remote Sensing</em> 14 (17): 4181. <a href="https://doi.org/10.3390/rs14174181">https://doi.org/10.3390/rs14174181</a>.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>